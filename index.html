<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Vendas HOYA - Torneio 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Rajdhani', sans-serif;
        }
        
        .orbitron {
            font-family: 'Orbitron', monospace;
        }
        
        .space-bg {
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 30%, #16213e 60%, #0f3460 100%);
            position: relative;
            overflow-y: auto;
        }
        
        .space-bg::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(2px 2px at 20px 30px, #eee, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 160px 30px, rgba(255,255,255,0.4), transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: sparkle 3s linear infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        @keyframes sparkle {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-100px); }
        }
        
        .glass-effect {
            background: rgba(15, 23, 42, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.4);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 20px rgba(59, 130, 246, 0.1);
            position: relative;
            z-index: 2;
        }
        
        .glass-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, transparent 50%, rgba(147, 51, 234, 0.1) 100%);
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .glass-effect:hover::before {
            opacity: 1;
        }
        
        .hover-glow {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 2;
        }
        
        .hover-glow:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 20px 40px rgba(59, 130, 246, 0.4),
                0 0 30px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .progress-bar {
            transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
            background-size: 200% 100%;
            animation: progressShine 2s ease-in-out infinite;
        }
        
        @keyframes progressShine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .nav-tab {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        .nav-tab:hover {
            background: rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }
        
        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .nav-tab:hover::before {
            left: 100%;
        }
        
        .gamer-button {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .gamer-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }
        
        .gamer-button:hover::before {
            left: 100%;
        }
        
        .gamer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }
        
        .gamer-input {
            background: rgba(15, 23, 42, 0.4);
            border: 2px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        
        .gamer-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            background: rgba(15, 23, 42, 0.6);
        }

        .gamer-input option {
            background: #1e293b;
            color: #ffffff;
            padding: 8px;
        }
        
        .neon-text {
            text-shadow: 
                0 0 5px rgba(59, 130, 246, 0.8),
                0 0 10px rgba(59, 130, 246, 0.6),
                0 0 15px rgba(59, 130, 246, 0.4);
        }
        
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulseGlow {
            from {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            }
            to {
                box-shadow: 0 0 30px rgba(59, 130, 246, 0.8);
            }
        }
        
        .rank-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.4) 0%, rgba(30, 64, 175, 0.2) 100%);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .rank-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 
                0 0 20px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-5px);
        }
        
        .rank-unlocked {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.3) 100%);
            border: 2px solid rgba(34, 197, 94, 0.4);
        }
        
        .rank-current {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 193, 7, 0.3) 100%);
            border: 2px solid rgba(255, 215, 0, 0.6);
            animation: currentRankGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes currentRankGlow {
            from {
                box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            }
            to {
                box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
            }
        }
        
        .training-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.4) 0%, rgba(30, 64, 175, 0.2) 100%);
            border: 2px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        
        .training-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            transform: translateY(-5px);
        }
        
        .lesson-complete {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.3) 100%);
            border: 1px solid rgba(34, 197, 94, 0.4);
        }
        
        .lesson-incomplete {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.3) 0%, rgba(59, 130, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .product-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .product-card:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .product-card.selected {
            border-color: #fbbf24 !important;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5), 0 0 40px rgba(251, 191, 36, 0.3);
            transform: translateY(-3px) scale(1.05);
        }
        
        .product-card.selected::before {
            content: '✓';
            position: absolute;
            top: 4px;
            right: 4px;
            background: #fbbf24;
            color: #000;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }
        
        .product-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .product-card:hover::after {
            left: 100%;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            padding: 16px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.9));
            border: 1px solid rgba(34, 197, 94, 0.5);
        }
        
        .notification-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        
        .notification-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9));
            border: 1px solid rgba(59, 130, 246, 0.5);
        }
        
        @media (max-width: 1024px) {
            .orbitron {
                font-size: 1.5rem;
            }
            
            .glass-effect {
                backdrop-filter: blur(15px);
                padding: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }
            
            .nav-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
                flex: 1;
                text-align: center;
            }
            
            .glass-effect {
                backdrop-filter: blur(10px);
                padding: 0.75rem;
            }
            
            .orbitron {
                font-size: 1.25rem;
            }
            
            .notification {
                max-width: 90%;
                right: 5%;
                left: 5%;
                transform: translateY(-100%);
            }
            
            .notification.show {
                transform: translateY(0);
            }
            
            /* Header responsivo - manter horizontal */
            header .flex {
                flex-wrap: wrap;
                gap: 0.5rem;
                align-items: center;
            }
            
            header .flex > div:first-child {
                flex: 1;
                min-width: 200px;
            }
            
            header .flex > div:last-child {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            /* Cards responsivos */
            .grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 0.75rem;
            }
            
            .grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            /* Tabelas responsivas */
            table {
                font-size: 0.875rem;
            }
            
            th, td {
                padding: 0.5rem 0.25rem;
            }
            
            /* Modais responsivos */
            .max-w-2xl {
                max-width: 95%;
                max-height: 80vh;
                overflow-y: auto;
            }
            
            .max-w-md {
                max-width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            }
            
            /* Formulários responsivos */
            .grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            /* Garantir espaço para rolagem */
            #mainSystem {
                padding-bottom: 2rem !important;
                min-height: 100vh;
            }
            
            .max-w-7xl {
                padding-bottom: 2rem !important;
            }
        }
        
        @media (max-width: 640px) {
            body {
                padding-bottom: 2rem;
            }
            
            .grid-cols-2 { 
                grid-template-columns: repeat(1, minmax(0, 1fr));
                gap: 0.5rem;
            }
            
            .grid-cols-3, .grid-cols-4 { 
                grid-template-columns: repeat(1, minmax(0, 1fr));
                gap: 0.5rem;
            }
            
            .nav-tab {
                padding: 0.375rem 0.5rem;
                font-size: 0.75rem;
                min-width: 0;
            }
            
            .glass-effect {
                padding: 0.5rem;
            }
            
            .orbitron {
                font-size: 1rem;
            }
            
            /* Header mobile */
            header {
                padding: 0.75rem;
            }
            
            header .flex {
                gap: 0.5rem;
                justify-content: space-between;
                align-items: center;
            }
            
            header .flex .flex {
                gap: 0.25rem;
                align-items: center;
            }
            
            /* Navegação mobile */
            nav .flex {
                flex-wrap: wrap;
                gap: 0.25rem;
            }
            
            /* Cards mobile */
            .glass-effect.rounded-xl.p-6 {
                padding: 0.75rem;
            }
            
            /* Texto responsivo */
            .text-4xl {
                font-size: 1.875rem;
            }
            
            .text-3xl {
                font-size: 1.5rem;
            }
            
            .text-2xl {
                font-size: 1.25rem;
            }
            
            .text-xl {
                font-size: 1.125rem;
            }
            
            /* Botões mobile */
            .gamer-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            
            /* Inputs mobile */
            .gamer-input {
                padding: 0.75rem;
                font-size: 0.875rem;
            }
            
            /* Tabelas mobile - scroll horizontal */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 500px;
                font-size: 0.75rem;
            }
            
            th, td {
                padding: 0.375rem 0.25rem;
                white-space: nowrap;
            }
            
            /* Modais mobile */
            .max-h-\\[85vh\\] {
                max-height: 75vh !important;
            }
            
            /* Desafios mobile */
            #activeChallenges .glass-effect {
                padding: 0.5rem;
            }
            
            #activeChallenges .text-sm {
                font-size: 0.75rem;
            }
            
            /* Vendas recentes mobile */
            #recentSales .glass-effect {
                padding: 0.5rem;
            }
            
            /* Ranking mobile */
            .rank-card, .training-card {
                padding: 0.75rem;
            }
            
            /* Ícones do header mobile */
            .w-8.h-8 {
                width: 1.75rem;
                height: 1.75rem;
            }
            
            .w-12.h-12 {
                width: 2.25rem;
                height: 2.25rem;
            }
            
            /* Garantir espaço extra para rolagem */
            #mainSystem {
                padding-bottom: 3rem !important;
            }
            
            .max-w-7xl {
                padding-bottom: 3rem !important;
            }
        }
        
        @media (max-width: 480px) {
            /* Extra small devices */
            .container {
                padding: 0.5rem;
            }
            
            .max-w-7xl {
                padding: 0 0.5rem;
            }
            
            /* Header extra small */
            header .flex .flex {
                justify-content: center;
            }
            
            /* Cards extra small */
            .grid-cols-2, .grid-cols-3, .grid-cols-4 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            /* Navegação extra small */
            .nav-tab {
                padding: 0.25rem 0.375rem;
                font-size: 0.625rem;
            }
            
            /* Texto extra small */
            .text-4xl {
                font-size: 1.5rem;
            }
            
            .text-3xl {
                font-size: 1.25rem;
            }
            
            .text-2xl {
                font-size: 1.125rem;
            }
            
            /* Modais extra small */
            .max-w-2xl, .max-w-md {
                max-width: 98%;
                margin: 0.5rem;
            }
            
            /* Formulário de vendas mobile */
            .space-y-6 {
                gap: 1rem;
            }
            
            .space-y-4 {
                gap: 0.75rem;
            }
        }
        
        /* Orientação landscape em mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .min-h-screen {
                min-height: 100vh;
            }
            
            header {
                padding: 0.5rem;
            }
            
            .glass-effect.rounded-xl.p-6 {
                padding: 0.5rem;
            }
            
            .nav-tab {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
        
        /* Garantir scroll funcional */
        html, body {
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        body {
            min-height: 100vh;
            position: relative;
        }
        
        /* Scroll personalizado */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.5);
            border-radius: 6px;
            border: 2px solid rgba(0, 0, 0, 0.1);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.7);
        }
        
        ::-webkit-scrollbar-thumb:active {
            background: rgba(59, 130, 246, 0.9);
        }
        
        /* Scroll para Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(59, 130, 246, 0.5) rgba(0, 0, 0, 0.2);
        }
        
        /* Garantir que o conteúdo seja rolável */
        #mainSystem {
            min-height: 100vh;
            overflow-y: visible;
        }
        
        .max-w-7xl {
            position: relative;
            z-index: 1;
        }
        
        /* Melhorias para touch */
        @media (hover: none) and (pointer: coarse) {
            .hover-glow:hover {
                transform: none;
                box-shadow: none;
            }
            
            .nav-tab:hover {
                background: rgba(59, 130, 246, 0.15);
                transform: none;
            }
            
            .gamer-button:hover {
                transform: none;
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            }
            
            /* Aumentar área de toque */
            .nav-tab, .gamer-button, button {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body class="space-bg min-h-screen">
    <!-- Tela de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl p-8 w-full max-w-md fade-in pulse-glow">
            <div class="text-center mb-8">
                <h1 class="orbitron text-4xl font-bold text-white mb-2 neon-text">SISTEMA HOYA</h1>
                <p class="text-blue-100">Torneio de Vendas 2025</p>
            </div>
            
            <div id="loginForm">
                <div class="space-y-4">
                    <input type="text" id="loginEmail" placeholder="Email ou usuário" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                    <input type="password" id="loginPassword" placeholder="Senha" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                    <button onclick="login()" class="w-full gamer-button text-white p-3 rounded-lg font-semibold hover-glow">ENTRAR</button>
                    <div class="flex justify-between text-sm">
                        <button onclick="showRegister()" class="text-blue-200 hover:text-white transition-colors">Cadastrar-se</button>
                        <button onclick="showForgotPassword()" class="text-blue-200 hover:text-white transition-colors">Esqueci minha senha</button>
                    </div>
                </div>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="space-y-4">
                    <input type="text" id="regName" placeholder="Nome completo" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                    <div class="relative">
                        <input type="email" id="regEmail" placeholder="Email" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none" oninput="showEmailSuggestions(this.value)">
                        <div id="emailSuggestions" class="absolute top-full left-0 right-0 bg-slate-800 border border-blue-500/30 rounded-lg mt-1 hidden z-10 max-h-40 overflow-y-auto"></div>
                    </div>
                    <input type="tel" id="regPhone" placeholder="Telefone" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                    <input type="text" id="regOptica" placeholder="Ótica" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                    <input type="text" id="regCity" placeholder="Cidade" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                    <input type="text" id="regHoyaCode" placeholder="Código HOYA" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                    <select id="regFunction" class="w-full p-3 rounded-lg gamer-input text-white focus:outline-none">
                        <option value="">Selecione a função</option>
                        <option value="vendedor">Vendedor</option>
                    </select>
                    <input type="password" id="regPassword" placeholder="Criar senha" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                    <div class="flex space-x-2">
                        <button onclick="register()" class="flex-1 gamer-button text-white p-3 rounded-lg font-semibold hover-glow">CADASTRAR</button>
                        <button onclick="showLogin()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg font-semibold hover-glow">VOLTAR</button>
                    </div>
                </div>
            </div>
            
            <div id="forgotForm" class="hidden">
                <div class="space-y-4">
                    <input type="email" id="forgotEmail" placeholder="Digite seu email" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                    <button onclick="resetPassword()" class="w-full bg-orange-600 hover:bg-orange-700 text-white p-3 rounded-lg font-semibold hover-glow">ENVIAR NOVA SENHA</button>
                    <button onclick="showLogin()" class="w-full bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg font-semibold hover-glow">VOLTAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" class="hidden min-h-screen">
        <!-- Header -->
        <header class="glass-effect p-4 mb-4">
            <div class="max-w-7xl mx-auto">
                <!-- Mobile Layout -->
                <div class="md:hidden">
                    <!-- Linha superior: Perfil + Informações principais -->
                    <div class="flex items-center justify-between mb-3">
                        <!-- Perfil e Nome -->
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white hover-glow transition-all duration-300 cursor-pointer flex-shrink-0 overflow-hidden border-2 border-blue-400/30" onclick="openProfileModal()" id="profileIcon" title="Meu Perfil">
                                <span class="text-lg">👤</span>
                            </div>
                            <div>
                                <h3 class="text-white font-bold text-sm orbitron neon-text" id="welcomeMessageMobile">BEM-VINDO!</h3>
                                <p class="text-blue-200 text-xs" id="userInfoMobile">Sistema HOYA 2025</p>
                            </div>
                        </div>
                        
                        <!-- Ícones de ação -->
                        <div class="flex items-center space-x-2">
                            <button onclick="openRulesModal()" class="w-8 h-8 glass-effect rounded-full flex items-center justify-center text-white hover-glow transition-all duration-300" title="Regras">
                                <span class="text-sm">ℹ️</span>
                            </button>
                            
                            <button onclick="openMessagesModal()" class="w-8 h-8 glass-effect rounded-full flex items-center justify-center text-white hover-glow transition-all duration-300 relative" title="Mensagens" id="messagesButton">
                                <span class="text-sm">✉️</span>
                                <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-xs flex items-center justify-center text-white font-bold pulse-glow" id="messagesBadge" style="font-size: 9px;">2</span>
                            </button>
                            
                            <button onclick="logout()" class="gamer-button px-3 py-1.5 rounded-lg text-white hover-glow transition-all duration-300 font-semibold text-xs">
                                SAIR
                            </button>
                        </div>
                    </div>
                    
                    <!-- Linha inferior: Cards de estatísticas -->
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <!-- Card Pontos Totais -->
                        <div class="glass-effect px-3 py-2 rounded-lg text-center hover-glow">
                            <div class="flex items-center justify-center mb-1">
                                <span class="text-lg mr-1">⭐</span>
                                <p class="text-blue-200 text-xs font-medium">Pontos</p>
                            </div>
                            <p class="orbitron text-white font-bold text-sm neon-text" id="totalPoints">0</p>
                        </div>
                        
                        <!-- Card Patente -->
                        <div class="glass-effect px-3 py-2 rounded-lg text-center hover-glow">
                            <div class="flex items-center justify-center mb-1">
                                <span class="text-lg mr-1">🎖️</span>
                                <p class="text-blue-200 text-xs font-medium">Patente</p>
                            </div>
                            <p class="text-white font-bold text-xs truncate" id="currentRank">Iniciante</p>
                        </div>
                    </div>
                    

                </div>
                
                <!-- Desktop Layout -->
                <div class="hidden md:flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white hover-glow transition-all duration-300 cursor-pointer overflow-hidden border-2 border-blue-400/30" onclick="openProfileModal()" id="profileIconDesktop" title="Meu Perfil">
                            <span class="text-lg">👤</span>
                        </div>
                        <div>
                            <h2 class="orbitron text-white font-semibold text-lg neon-text" id="welcomeMessageDesktop">BEM-VINDO!</h2>
                            <p class="text-blue-200 text-sm" id="userInfoDesktop">Sistema de Vendas 2025</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="glass-effect px-4 py-2 rounded-lg text-center hover-glow">
                            <p class="text-blue-200 text-xs">Pontos Totais</p>
                            <p class="orbitron text-white font-bold text-lg neon-text" id="totalPointsDesktop">0</p>
                        </div>
                        <div class="glass-effect px-4 py-2 rounded-lg text-center hover-glow">
                            <p class="text-blue-200 text-xs">Patente</p>
                            <p class="text-white font-bold text-sm" id="currentRankDesktop">Iniciante</p>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <button onclick="openRulesModal()" class="w-10 h-10 glass-effect rounded-full flex items-center justify-center text-white hover-glow transition-all duration-300" title="Regras do Torneio">
                                <span class="text-lg">ℹ️</span>
                            </button>
                            <button onclick="openMessagesModal()" class="w-10 h-10 glass-effect rounded-full flex items-center justify-center text-white hover-glow transition-all duration-300 relative" title="Mensagens" id="messagesButtonDesktop">
                                <span class="text-lg">✉️</span>
                                <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-xs flex items-center justify-center text-white font-bold pulse-glow" id="messagesBadgeDesktop">2</span>
                            </button>
                        </div>
                        
                        <button onclick="logout()" class="gamer-button px-4 py-2 rounded-lg text-white hover-glow transition-all duration-300 font-semibold">
                            SAIR
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navegação -->
        <nav class="max-w-7xl mx-auto mb-4 px-3">
            <div class="glass-effect rounded-xl p-2">
                <div class="flex flex-wrap gap-1 justify-center">
                    <button onclick="showTab('home')" class="nav-tab active px-2 py-2 rounded-lg font-medium hover-glow text-white text-xs flex-1 min-w-0" data-tab="home">HOME</button>
                    <button onclick="showTab('vendas')" class="nav-tab px-2 py-2 rounded-lg font-medium text-white hover-glow text-xs flex-1 min-w-0" data-tab="vendas">VENDAS</button>
                    <button onclick="showTab('desempenho')" class="nav-tab px-2 py-2 rounded-lg font-medium text-white hover-glow text-xs flex-1 min-w-0" data-tab="desempenho">STATS</button>
                    <button onclick="showTab('ranking')" class="nav-tab px-2 py-2 rounded-lg font-medium text-white hover-glow text-xs flex-1 min-w-0" data-tab="ranking">RANK</button>
                    <button onclick="showTab('patentes')" class="nav-tab px-2 py-2 rounded-lg font-medium text-white hover-glow text-xs flex-1 min-w-0" data-tab="patentes">PATENTES</button>
                    <button onclick="showTab('cursos')" class="nav-tab px-2 py-2 rounded-lg font-medium text-white hover-glow text-xs flex-1 min-w-0" data-tab="cursos">TREINAMENTOS</button>
                    <button onclick="showTab('premios')" class="nav-tab px-2 py-2 rounded-lg font-medium text-white hover-glow text-xs flex-1 min-w-0" data-tab="premios">PRÊMIOS</button>
                </div>
            </div>
        </nav>

        <!-- Conteúdo das Abas -->
        <div class="max-w-7xl mx-auto px-3 pb-8">
            <!-- Aba Home -->
            <div id="tab-home" class="tab-content">
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="glass-effect rounded-xl p-4 hover-glow">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-blue-200 font-semibold text-xs">RANKING</h3>
                            <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                        </div>
                        <p class="orbitron text-white font-bold text-lg" id="rankPosition">-</p>
                    </div>
                    <div class="glass-effect rounded-xl p-4 hover-glow">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-blue-200 font-semibold text-xs">TOTAL VENDAS</h3>
                            <div class="w-2 h-2 bg-purple-400 rounded-full"></div>
                        </div>
                        <p class="orbitron text-white font-bold text-lg" id="totalSales">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Vendas Recentes -->
                    <div class="glass-effect rounded-xl p-4">
                        <h3 class="orbitron text-white text-lg font-semibold mb-3 neon-text">VENDAS RECENTES</h3>
                        <div id="recentSales" class="space-y-2 max-h-60 overflow-y-auto">
                            <p class="text-blue-200 text-center py-6 text-sm">Nenhuma venda registrada ainda</p>
                        </div>
                    </div>

                    <!-- Desafios Ativos -->
                    <div class="glass-effect rounded-xl p-4">
                        <h3 class="orbitron text-white text-lg font-semibold mb-3 neon-text">DESAFIOS ATIVOS</h3>
                        <div class="space-y-3" id="activeChallenges">
                            <!-- Desafios serão carregados dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba +Vendas -->
            <div id="tab-vendas" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- Informações da Venda -->
                    <div class="glass-effect rounded-xl p-4 hover-glow">
                        <h2 class="orbitron text-white text-xl font-bold mb-4 text-center neon-text">REGISTRAR NOVA VENDA</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-blue-200 text-sm block mb-2 font-semibold">NOME DO CLIENTE</label>
                                <input type="text" id="saleClient" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none" placeholder="Nome completo">
                            </div>
                            <div>
                                <label class="text-blue-200 text-sm block mb-2 font-semibold">ID DO PEDIDO HOYA</label>
                                <input type="text" id="saleOrderId" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none" placeholder="Ex: HY2025001">
                            </div>
                            <div>
                                <label class="text-blue-200 text-sm block mb-2 font-semibold">DATA DA VENDA</label>
                                <input type="date" id="saleDate" class="w-full p-3 rounded-lg gamer-input text-white focus:outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- Seleção de Produtos com Dropdowns -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Tipos de Lentes -->
                        <div class="glass-effect rounded-xl p-4">
                            <label class="text-blue-200 text-sm block mb-2 font-semibold">TIPO DE LENTE *</label>
                            <div class="relative">
                                <select id="saleLensType" class="w-full p-3 rounded-lg gamer-input text-white focus:outline-none appearance-none cursor-pointer" onchange="updateSelectedProduct('lensType', this.value)">
                                    <option value="">Selecione o tipo de lente</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                    <svg class="w-4 h-4 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                                

                                

                            </div>
                        </div>

                        <!-- Tratamentos Antirreflexo -->
                        <div class="glass-effect rounded-xl p-4">
                            <label class="text-blue-200 text-sm block mb-2 font-semibold">TRATAMENTO ANTIRREFLEXO</label>
                            <div class="relative">
                                <select id="saleAntiReflective" class="w-full p-3 rounded-lg gamer-input text-white focus:outline-none appearance-none cursor-pointer" onchange="updateSelectedProduct('antiReflective', this.value)">
                                    <option value="none">Sem tratamento antirreflexo</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                    <svg class="w-4 h-4 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                                

                                

                            </div>
                        </div>

                        <!-- Sensity (Fotossensível) -->
                        <div class="glass-effect rounded-xl p-4">
                            <label class="text-blue-200 text-sm block mb-2 font-semibold">SENSITY (FOTOSSENSÍVEL)</label>
                            <div class="relative">
                                <select id="saleSensity" class="w-full p-3 rounded-lg gamer-input text-white focus:outline-none appearance-none cursor-pointer" onchange="updateSelectedProduct('sensity', this.value)">
                                    <option value="none">Sem Sensity</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                    <svg class="w-4 h-4 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                                

                                

                            </div>
                        </div>

                        <!-- Materiais -->
                        <div class="glass-effect rounded-xl p-4">
                            <label class="text-blue-200 text-sm block mb-2 font-semibold">MATERIAL</label>
                            <div class="relative">
                                <select id="saleMaterial" class="w-full p-3 rounded-lg gamer-input text-white focus:outline-none appearance-none cursor-pointer" onchange="updateSelectedProduct('material', this.value)">
                                    <option value="">Sem material específico</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                    <svg class="w-4 h-4 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                                

                                

                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumo de Pontos -->
                    <div class="glass-effect rounded-lg p-4 bg-gradient-to-r from-green-600/20 to-blue-600/20">
                        <h3 class="text-white font-semibold mb-2">Resumo de Pontos</h3>
                        <div id="pointsBreakdown" class="text-blue-200 text-sm space-y-1">
                            <p>Selecione os produtos para ver a pontuação</p>
                        </div>
                        <div class="mt-3 pt-3 border-t border-white/20">
                            <p class="text-white font-bold text-lg">Total: <span id="totalPointsPreview">0</span> pontos</p>
                        </div>
                    </div>
                    <button onclick="registerSale()" class="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg font-semibold hover-glow">REGISTRAR VENDA</button>
                </div>
            </div>

            <!-- Aba Desempenho -->
            <div id="tab-desempenho" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- Métricas de Performance -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="glass-effect rounded-xl p-4 hover-glow text-center">
                            <span class="text-2xl mb-2 block">📊</span>
                            <div class="text-2xl font-bold text-white orbitron" id="totalGeneralSales">0</div>
                            <div class="text-blue-200 text-sm">Total Geral de Vendas</div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 hover-glow text-center">
                            <span class="text-2xl mb-2 block">📈</span>
                            <div class="text-2xl font-bold text-white orbitron" id="totalMonthlySales">0</div>
                            <div class="text-blue-200 text-sm">Vendas Este Mês</div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 hover-glow text-center">
                            <span class="text-2xl mb-2 block">⚡</span>
                            <div class="text-2xl font-bold text-white orbitron" id="totalWeeklySales">0</div>
                            <div class="text-blue-200 text-sm">Vendas Esta Semana</div>
                        </div>
                        <div class="glass-effect rounded-xl p-4 hover-glow text-center">
                            <span class="text-2xl mb-2 block">🎯</span>
                            <div class="text-2xl font-bold text-white orbitron" id="averageTicket">0</div>
                            <div class="text-blue-200 text-sm">Ticket Médio (pts)</div>
                        </div>
                    </div>

                    <!-- Tabela de Vendas -->
                    <div class="glass-effect rounded-xl p-6">
                        <h2 class="text-white text-2xl font-bold mb-6">MINHAS VENDAS</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b border-white/20">
                                        <th class="text-blue-200 font-medium py-3 px-2">Data</th>
                                        <th class="text-blue-200 font-medium py-3 px-2">Cliente</th>
                                        <th class="text-blue-200 font-medium py-3 px-2">ID do Pedido</th>
                                        <th class="text-blue-200 font-medium py-3 px-2">Produto</th>
                                        <th class="text-blue-200 font-medium py-3 px-2">Pontos</th>
                                    </tr>
                                </thead>
                                <tbody id="salesTableBody">
                                    <tr>
                                        <td colspan="5" class="text-blue-200 text-center py-8">Nenhuma venda registrada ainda</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Ranking -->
            <div id="tab-ranking" class="tab-content hidden">
                <div class="glass-effect rounded-xl p-6">
                    <h2 class="text-white text-2xl font-bold mb-6 text-center">RANKING GERAL</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-white/20">
                                    <th class="text-blue-200 font-medium py-3 px-2 text-center w-20">Posição</th>
                                    <th class="text-blue-200 font-medium py-3 px-2 text-left">Vendedor</th>
                                    <th class="text-blue-200 font-medium py-3 px-2 text-left">Ótica</th>
                                    <th class="text-blue-200 font-medium py-3 px-2 text-center w-20">Vendas</th>
                                    <th class="text-blue-200 font-medium py-3 px-2 text-right w-32">Pontos</th>
                                </tr>
                            </thead>
                            <tbody id="rankingTableBody">
                                <tr>
                                    <td colspan="5" class="text-blue-200 text-center py-8">Carregando ranking...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Aba Patentes -->
            <div id="tab-patentes" class="tab-content hidden">
                <div class="glass-effect rounded-xl p-6">
                    <h2 class="text-white text-2xl font-bold mb-6 text-center">SISTEMA DE PATENTES</h2>
                    <p class="text-blue-200 text-center mb-8">Desbloqueie patentes automaticamente conforme acumula pontos!</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="ranksList">
                        <!-- Patentes serão carregadas dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Aba Treinamentos -->
            <div id="tab-cursos" class="tab-content hidden">
                <div class="glass-effect rounded-xl p-6">
                    <h2 class="orbitron text-white text-3xl font-bold mb-6 text-center neon-text">CENTRO DE TREINAMENTOS</h2>
                    <p class="text-blue-200 text-center mb-8 text-lg">Complete as aulas e ganhe certificados valiosos!</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="trainingsList">
                        <!-- Treinamentos serão carregados dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Aba Prêmios -->
            <div id="tab-premios" class="tab-content hidden">
                <div class="glass-effect rounded-xl p-6">
                    <h2 class="text-white text-2xl font-bold mb-6 text-center">🏆 PRÊMIOS E RECOMPENSAS</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Prêmios Trimestrais -->
                        <div class="glass-effect rounded-xl p-6">
                            <h3 class="text-white text-xl font-bold mb-4 flex items-center">
                                <span class="text-2xl mr-2">🏆</span>
                                Prêmios Trimestrais
                            </h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-gradient-to-r from-yellow-600/20 to-yellow-500/20 rounded-lg border border-yellow-500/30">
                                    <div class="flex items-center">
                                        <span class="text-2xl mr-3">🥇</span>
                                        <div>
                                            <p class="text-white font-semibold">1º Lugar</p>
                                            <p class="text-yellow-200 text-sm">Campeão do Trimestre</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-yellow-300 font-bold">HiperPrêmio Turbinado</p>
                                        <p class="text-yellow-200 text-sm">R$ 1.000,00 + Troféu</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-gradient-to-r from-gray-400/20 to-gray-300/20 rounded-lg border border-gray-400/30">
                                    <div class="flex items-center">
                                        <span class="text-2xl mr-3">🥈</span>
                                        <div>
                                            <p class="text-white font-semibold">2º Lugar</p>
                                            <p class="text-gray-200 text-sm">Vice-Campeão</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-gray-300 font-bold">HiperPrêmio Turbinado</p>
                                        <p class="text-gray-200 text-sm">R$ 500,00 + Troféu</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-gradient-to-r from-orange-600/20 to-orange-500/20 rounded-lg border border-orange-500/30">
                                    <div class="flex items-center">
                                        <span class="text-2xl mr-3">🥉</span>
                                        <div>
                                            <p class="text-white font-semibold">3º Lugar</p>
                                            <p class="text-orange-200 text-sm">Terceiro Colocado</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-orange-300 font-bold">HiperPrêmio Turbinado</p>
                                        <p class="text-orange-200 text-sm">R$ 300,00 + Troféu</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-gradient-to-r from-blue-600/20 to-blue-500/20 rounded-lg border border-blue-500/30">
                                    <div class="flex items-center">
                                        <span class="text-2xl mr-3">👁️</span>
                                        <div>
                                            <p class="text-white font-semibold">Meta MiYoSmart</p>
                                            <p class="text-blue-200 text-sm">Maior Vendedor</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-blue-300 font-bold">Kit HOYA Premium</p>
                                        <p class="text-blue-200 text-sm">Especialista MiYoSmart</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between p-3 bg-gradient-to-r from-purple-600/20 to-purple-500/20 rounded-lg border border-purple-500/30">
                                    <div class="flex items-center">
                                        <span class="text-2xl mr-3">🎯</span>
                                        <div>
                                            <p class="text-white font-semibold">Meta MySelf</p>
                                            <p class="text-purple-200 text-sm">Maior Vendedor</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-purple-300 font-bold">Kit HOYA Premium</p>
                                        <p class="text-purple-200 text-sm">Especialista MySelf</p>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Status Atual -->
                        <div class="glass-effect rounded-xl p-6">
                            <h3 class="text-white text-xl font-bold mb-4 flex items-center">
                                <span class="text-2xl mr-2">📊</span>
                                Seu Progresso Atual
                            </h3>
                            <div class="space-y-4">
                                <div class="text-center p-4 bg-gradient-to-b from-blue-600/20 to-blue-700/20 rounded-lg">
                                    <p class="text-blue-200 text-sm mb-1">Posição Atual</p>
                                    <p class="text-white text-2xl font-bold" id="currentPosition">-</p>
                                    <p class="text-blue-300 text-xs">no ranking geral</p>
                                </div>
                                <div class="text-center p-4 bg-gradient-to-b from-green-600/20 to-green-700/20 rounded-lg">
                                    <p class="text-green-200 text-sm mb-1">Pontos Este Mês</p>
                                    <p class="text-white text-2xl font-bold" id="currentMonthPoints">0</p>
                                    <p class="text-green-300 text-xs">pontos acumulados</p>
                                </div>
                                <div class="text-center p-4 bg-gradient-to-b from-purple-600/20 to-purple-700/20 rounded-lg">
                                    <p class="text-purple-200 text-sm mb-1">Próximo Prêmio</p>
                                    <p class="text-white text-lg font-bold" id="nextPrize">Top 3</p>
                                    <p class="text-purple-300 text-xs">continue assim!</p>
                                </div>
                                

                                

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Perfil -->
    <div id="profileModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="glass-effect rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white text-xl font-bold">MEU PERFIL</h3>
                <button onclick="closeProfileModal()" class="text-white hover:text-red-400 text-2xl">✕</button>
            </div>
            <div class="space-y-4">
                <div class="text-center">
                    <div class="w-20 h-20 rounded-lg flex items-center justify-center text-white font-bold text-2xl mx-auto mb-2 cursor-pointer hover-glow transition-all duration-300 overflow-hidden border-2 border-blue-400/30" onclick="changeProfilePhoto()" id="profileModalIcon">
                        👤
                    </div>
                    <button onclick="changeProfilePhoto()" class="text-blue-400 text-sm hover:text-white">Alterar Foto</button>
                </div>
                <input type="text" id="profileName" placeholder="Nome completo" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                <input type="tel" id="profilePhone" placeholder="Telefone" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                <input type="text" id="profileCity" placeholder="Cidade" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                <input type="text" id="profileOptica" placeholder="Ótica" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                <input type="text" id="profileHoyaCode" placeholder="Código HOYA" class="w-full p-3 rounded-lg gamer-input text-white placeholder-blue-200 focus:outline-none">
                <div class="flex space-x-2">
                    <button onclick="saveProfile()" class="flex-1 gamer-button text-white p-3 rounded-lg font-semibold hover-glow">SALVAR</button>
                    <button onclick="closeProfileModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg font-semibold hover-glow">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Regras -->
    <div id="rulesModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-xl p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white text-xl font-bold">REGRAS DO TORNEIO</h3>
                <button onclick="closeRulesModal()" class="text-white hover:text-red-400 text-2xl">✕</button>
            </div>
            <div class="text-blue-200 space-y-4 max-h-96 overflow-y-auto">
                <h4 class="text-white font-semibold">🏆 ESTRUTURA DO TORNEIO</h4>
                <ul class="space-y-1 text-sm">
                    <li>• Torneio trimestral (4 torneios por ano)</li>
                    <li>• 1º Trimestre: Janeiro a Março</li>
                    <li>• 2º Trimestre: Abril a Junho</li>
                    <li>• 3º Trimestre: Julho a Setembro</li>
                    <li>• 4º Trimestre: Outubro a Dezembro</li>
                    <li>• Ranking zerado a cada final de trimestre</li>
                </ul>
                
                <h4 class="text-white font-semibold">📋 PONTUAÇÃO POR LENTES</h4>
                <ul class="space-y-1 text-sm">
                    <li>• MiYoSmart: 100 pts</li>
                    <li>• Myself: 90 pts</li>
                    <li>• MyStyle: 80 pts</li>
                    <li>• WorkStyle: 70 pts</li>
                    <li>• Lifestyle: 70 pts</li>
                    <li>• Enroute: 60 pts</li>
                    <li>• Balanssis: 60 pts</li>
                    <li>• Daynamic: 50 pts</li>
                    <li>• Sync: 40 pts</li>
                    <li>• Nulux ID V+: 40 pts</li>
                    <li>• Nulux trueform: 30 pts</li>
                    <li>• Maxxee: 20 pts</li>
                    <li>• Nulux surfaçadas: 15 pts</li>
                    <li>• Hilux surfaçadas: 15 pts</li>
                    <li>• Nulux Visão Simples: 10 pts</li>
                    <li>• Hilux Visão Simples: 10 pts</li>
                </ul>
                
                <h4 class="text-white font-semibold">💎 MATERIAIS</h4>
                <ul class="space-y-1 text-sm">
                    <li>• 1.74 EYVIA: 70 pts</li>
                    <li>• 1.67 EYNOA: 60 pts</li>
                    <li>• 1.60 EYAS 2.0: 50 pts</li>
                    <li>• 1.59 POLI: 40 pts</li>
                    <li>• 1.53 PNX: 35 pts</li>
                    <li>• 1.50 ORGANIC: 30 pts</li>
                </ul>
                
                <h4 class="text-white font-semibold">✨ TRATAMENTOS ANTIRREFLEXO</h4>
                <ul class="space-y-1 text-sm">
                    <li>• Meiryo: 70 pts</li>
                    <li>• AR MiYoSmart: 70 pts</li>
                    <li>• SunPro: 60 pts</li>
                    <li>• LongLife: 50 pts</li>
                    <li>• BlueControl: 40 pts</li>
                    <li>• NoRisk: 30 pts</li>
                </ul>
                
                <h4 class="text-white font-semibold">🌞 SENSITY (FOTOSSENSÍVEL)</h4>
                <ul class="space-y-1 text-sm">
                    <li>• Chameleon: 70 pts</li>
                    <li>• Sensity Shine: 60 pts</li>
                    <li>• Sensity Dark: 55 pts</li>
                    <li>• Sensity Fast: 50 pts</li>
                    <li>• Sensity 2: 45 pts</li>
                    <li>• Sensity Original: 40 pts</li>
                </ul>
                
                <h4 class="text-white font-semibold">🎯 DESAFIOS ATIVOS</h4>
                <p class="text-white font-medium">SEMANAIS:</p>
                <ul class="space-y-1 text-sm">
                    <li>• MiYoSmart: 6 vendas = +1000 pts</li>
                    <li>• Variedade: 6 tipos diferentes = +500 pts</li>
                    <li>• Premium 1.74: 3 lentes = +600 pts</li>
                    <li>• Sensity: 6 lentes fotossensíveis = +400 pts</li>
                </ul>
                <p class="text-white font-medium">MENSAIS:</p>
                <ul class="space-y-1 text-sm">
                    <li>• Meta Pontos: 20.000 pts = +1000 pts</li>
                    <li>• Meta Vendas: 50 vendas = +800 pts</li>
                    <li>• Meta Sensity: 15 lentes = +700 pts</li>
                    <li>• Antirreflexo: 15 Meiryo/AR = +900 pts</li>
                </ul>
                <p class="text-white font-medium">TRIMESTRAIS:</p>
                <ul class="space-y-1 text-sm">
                    <li>• MySelf: 6 vendas = +800 pts</li>
                </ul>
                
                <h4 class="text-white font-semibold">🎖️ SISTEMA DE PATENTES</h4>
                <ul class="space-y-1 text-sm">
                    <li>• Consultor Iniciante: Patente inicial, sem requisitos</li>
                    <li>• Consultor Júnior: 100.000 pts de vendas + bônus 1000 pts</li>
                    <li>• Consultor Pleno: 150.000 pts de vendas + bônus 1000 pts</li>
                    <li>• Consultor Sênior: 200.000 pts de vendas + bônus 1000 pts</li>
                    <li>• Consultor Master: 250.000 pts de vendas + bônus 1000 pts</li>
                    <li>• Consultor Elite: 300.000 pts de vendas + bônus 1000 pts</li>
                    <li>• Consultor Executivo: 350.000 pts de vendas + bônus 1000 pts</li>
                    <li>• Consultor Diretor: 400.000 pts de vendas + bônus 1000 pts</li>
                    <li>• Consultor Visionário: 450.000 pts de vendas + bônus 1000 pts</li>
                    <li>• Consultor Lendário: 500.000 pts de vendas + bônus 1000 pts</li>
                    <li>• Consultor Supremo: 550.000 pts de vendas + bônus 1000 pts</li>
                </ul>
                <p class="text-xs text-yellow-200">IMPORTANTE: Patentes são baseadas apenas em pontos de VENDAS cadastradas. Bônus de patente são pontos extras adicionados ao total vitalício e ranking mensal quando a patente é conquistada</p>
                
                <h4 class="text-white font-semibold">🎓 CERTIFICADOS</h4>
                <ul class="space-y-1 text-sm">
                    <li>• Cada curso concluído dá 400 pontos extras</li>
                    <li>• Cursos disponíveis: MiYoSmart, Multifocais, Sensity, BlueControl, etc...</li>
                    <li>• Complete todas as aulas de um curso para ganhar o certificado</li>
                    <li>• Certificados são adicionados ao total vitalício e ranking mensal</li>
                </ul>
                
                <h4 class="text-white font-semibold">🏆 PRÊMIOS TRIMESTRAIS</h4>
                <ul class="space-y-1 text-sm">
                    <li>• 🥇 1º Lugar: HiperPrêmio Turbinado + Troféu</li>
                    <li>• 🥈 2º Lugar: HiperPrêmio Turbinado + Troféu</li>
                    <li>• 🥉 3º Lugar: HiperPrêmio Turbinado + Troféu</li>
                    <li>• Meta MiYoSmart: Kit HOYA Premium (maior vendedor)</li>
                    <li>• Meta MySelf: Kit HOYA Premium (maior vendedor)</li>
                </ul>
                
                <h4 class="text-white font-semibold">⚠️ REGRAS IMPORTANTES</h4>
                <ul class="space-y-1 text-sm">
                    <li>• Toda venda exige ID único HOYA</li>
                    <li>• Pontos somados automaticamente</li>
                    <li>• Certificados: +400 pts cada</li>
                    <li>• Patentes: Bônus de 1000 pts cada</li>
                    <li>• Resets: Semanal (domingo), Mensal (último dia), Trimestral</li>
                    <li>• Sistema validado conforme regras oficiais do Torneio HOYA</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Modal de Mensagens -->
    <div id="messagesModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-xl p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white text-xl font-bold">MENSAGENS</h3>
                <button onclick="closeMessagesModal()" class="text-white hover:text-red-400 text-2xl">✕</button>
            </div>
            <div id="messagesContent" class="space-y-4">
                <!-- Mensagens serão carregadas dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Curso -->
    <div id="courseModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-xl p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white text-xl font-bold" id="courseModalTitle">Curso</h3>
                <button onclick="closeCourseModal()" class="text-white hover:text-red-400 text-2xl">✕</button>
            </div>
            <div id="courseModalContent">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Usuário -->
    <div id="userDetailsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="glass-effect rounded-xl p-6 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white text-xl font-bold flex items-center">
                    <span class="mr-2">👤</span>
                    Detalhes do Vendedor
                </h3>
                <button onclick="closeUserDetailsModal()" class="text-white hover:text-red-400 text-2xl">✕</button>
            </div>
            <div id="userDetailsContent">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>
    </div>

    <script>
        // Dados do sistema
        let currentUser = null;
        let monthlyRankingData = JSON.parse(localStorage.getItem('hoyaMonthlyRanking')) || {};
        
        // Função para atualizar ranking mensal
        function updateMonthlyRanking() {
            if (!currentUser) return;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthKey = `${currentYear}-${currentMonth}`;
            
            if (!monthlyRankingData[monthKey]) {
                monthlyRankingData[monthKey] = {};
            }
            
            monthlyRankingData[monthKey][currentUser.id] = {
                userId: currentUser.id,
                name: currentUser.name,
                optica: currentUser.optica,
                city: currentUser.city,
                points: currentUser.monthlyPoints || 0,
                sales: getMonthSales(),
                lastUpdate: new Date().toISOString()
            };
            
            localStorage.setItem('hoyaMonthlyRanking', JSON.stringify(monthlyRankingData));
        }
        
        // Sugestões de email
        const emailSuggestions = [
            '@gmail.com', '@hotmail.com', '@outlook.com', '@yahoo.com.br', 
            '@uol.com.br', '@terra.com.br', '@bol.com.br', '@ig.com.br'
        ];
        
        let users = JSON.parse(localStorage.getItem('hoyaUsers')) || [
            {
                id: 1,
                email: 'lider@hoya.com',
                username: 'liderhoya',
                password: 'Hoya@lider123',
                name: 'Líder HOYA',
                phone: '(11) 99999-9999',
                optica: 'HOYA Brasil',
                city: 'São Paulo',
                hoyaCode: 'HOYA001',
                function: 'lider',
                points: 0,
                salesPoints: 0,
                monthlyPoints: 0,
                sales: [],
                certificates: [],
                unlockedRanks: ['Consultor Iniciante'],
                challenges: initializeChallenges(),
                profilePhoto: null,
                lastMonthReset: new Date().getMonth(),
                isSystemUser: true
            },
            {
                id: 2,
                email: 'adm@hoya.com',
                username: 'admhoya',
                password: 'Hoya@123456789',
                name: 'Administrador HOYA',
                phone: '(11) 88888-8888',
                optica: 'HOYA Brasil',
                city: 'São Paulo',
                hoyaCode: 'HOYA002',
                function: 'administrador',
                points: 0,
                salesPoints: 0,
                monthlyPoints: 0,
                sales: [],
                certificates: [],
                unlockedRanks: ['Consultor Iniciante'],
                challenges: initializeChallenges(),
                profilePhoto: null,
                lastMonthReset: new Date().getMonth(),
                isSystemUser: true
            }
        ];

        // Pontuação oficial do Torneio HOYA
        const lensPoints = {
            'MiYoSmart': 100,
            'Myself': 90,
            'MyStyle': 80,
            'WorkStyle': 70,
            'Lifestyle': 70,
            'Enroute': 60,
            'Balanssis': 60,
            'Daynamic': 50,
            'Sync': 40,
            'Nulux ID V+': 40,
            'Nulux trueform': 30,
            'Maxxee': 20,
            'Nulux surfaçadas': 15,
            'Hilux surfaçadas': 15,
            'Nulux Visão Simples': 10,
            'Hilux Visão Simples': 10
        };

        const extraPoints = {
            antiReflective: {
                'Meiryo': 70,
                'AR MiYoSmart': 70,
                'SunPro': 60,
                'LongLife': 50,
                'BlueControl': 40,
                'NoRisk': 30
            },
            sensity: {
                'Chameleon': 70,
                'Sensity Shine': 60,
                'Sensity Dark': 55,
                'Sensity Fast': 50,
                'Sensity 2': 45,
                'Sensity Original': 40
            },
            material: {
                '1.74 EYVIA': 70,
                '1.67 EYNOA': 60,
                '1.60 EYAS 2.0': 50,
                '1.59 POLI': 40,
                '1.53 PNX': 35,
                '1.50 ORGANIC': 30
            }
        };

        // Sistema de Patentes (11 níveis)
        const ranks = [
            { name: 'Consultor Iniciante', points: 0, icon: '🎖️', color: 'text-gray-400' },
            { name: 'Consultor Júnior', points: 100000, icon: '🎖️', color: 'text-green-400' },
            { name: 'Consultor Pleno', points: 150000, icon: '🎖️', color: 'text-blue-400' },
            { name: 'Consultor Sênior', points: 200000, icon: '🎖️', color: 'text-purple-400' },
            { name: 'Consultor Master', points: 250000, icon: '🎖️', color: 'text-yellow-400' },
            { name: 'Consultor Elite', points: 300000, icon: '🎖️', color: 'text-orange-400' },
            { name: 'Consultor Executivo', points: 350000, icon: '🎖️', color: 'text-red-400' },
            { name: 'Consultor Diretor', points: 400000, icon: '🎖️', color: 'text-pink-400' },
            { name: 'Consultor Visionário', points: 450000, icon: '🎖️', color: 'text-indigo-400' },
            { name: 'Consultor Lendário', points: 500000, icon: '🎖️', color: 'text-cyan-400' },
            { name: 'Consultor Supremo', points: 550000, icon: '🎖️', color: 'text-emerald-400' }
        ];

        // Sistema de Treinamentos
        const trainings = [
            {
                id: 'miyosmart',
                name: 'MiYoSmart',
                icon: '🎓',
                description: 'Especialização em lentes para controle de miopia',
                lessons: [
                    { id: 1, name: 'Fundamentos da Miopia', completed: false },
                    { id: 2, name: 'Tecnologia MiYoSmart', completed: false },
                    { id: 3, name: 'Adaptação e Vendas', completed: false },
                    { id: 4, name: 'Casos Clínicos Avançados', completed: false }
                ]
            },
            {
                id: 'multifocal',
                name: 'Multifocais',
                icon: '🎓',
                description: 'Especialização em lentes multifocais',
                lessons: [
                    { id: 1, name: 'Tipos de Multifocais', completed: false },
                    { id: 2, name: 'Medidas e Adaptação', completed: false },
                    { id: 3, name: 'Resolução de Problemas', completed: false },
                    { id: 4, name: 'Vendas Consultivas', completed: false }
                ]
            },
            {
                id: 'transitions',
                name: 'Transitions',
                icon: '🎓',
                description: 'Especialização em lentes fotossensíveis',
                lessons: [
                    { id: 1, name: 'Tecnologia Fotossensível', completed: false },
                    { id: 2, name: 'Tipos de Transitions', completed: false },
                    { id: 3, name: 'Benefícios e Indicações', completed: false },
                    { id: 4, name: 'Técnicas de Vendas', completed: false }
                ]
            },
            {
                id: 'bluecontrol',
                name: 'BlueControl',
                icon: '🎓',
                description: 'Especialização em proteção contra luz azul',
                lessons: [
                    { id: 1, name: 'Luz Azul e Seus Efeitos', completed: false },
                    { id: 2, name: 'Tecnologia BlueControl', completed: false },
                    { id: 3, name: 'Público-Alvo', completed: false },
                    { id: 4, name: 'Argumentação de Vendas', completed: false }
                ]
            }
        ];

        // Inicializar desafios
        function initializeChallenges() {
            return {
                weekly: {
                    miyosmart: { current: 0, target: 6, reward: 1000, name: 'MiYoSmart Semanal' },
                    variety: { current: 0, target: 6, reward: 500, name: 'Variedade Semanal' },
                    premium: { current: 0, target: 3, reward: 600, name: 'Premium 1.74 Semanal' },
                    sensity: { current: 0, target: 6, reward: 400, name: 'Sensity Semanal' }
                },
                monthly: {
                    sales: { current: 0, target: 50, reward: 800, name: 'Meta Vendas Mensal' },
                    points: { current: 0, target: 20000, reward: 1000, name: 'Meta Pontos Mensal' },
                    photosensitive: { current: 0, target: 15, reward: 700, name: 'Meta Sensity Mensal' },
                    antireflective: { current: 0, target: 15, reward: 900, name: 'Antirreflexo Mensal' }
                },
                quarterly: {
                    lifestyle: { current: 0, target: 8, reward: 800, name: 'LifeStyle Trimestral' },
                    myself: { current: 0, target: 6, reward: 800, name: 'MySelf Trimestral' }
                }
            };
        }

        // Funções auxiliares
        function showEmailSuggestions(value) {
            const suggestionsDiv = document.getElementById('emailSuggestions');
            if (!value || value.includes('@')) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            const suggestions = emailSuggestions.map(domain => 
                `<div class="p-2 hover:bg-blue-600/20 cursor-pointer text-white" onclick="selectEmailSuggestion('${value}${domain}')">${value}${domain}</div>`
            ).join('');
            
            suggestionsDiv.innerHTML = suggestions;
            suggestionsDiv.classList.remove('hidden');
        }
        
        function selectEmailSuggestion(email) {
            document.getElementById('regEmail').value = email;
            document.getElementById('emailSuggestions').classList.add('hidden');
        }
        
        function setupUserInterface() {
            if (!currentUser) return;
            
            // Verificar reset mensal automático
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            if (currentUser.lastMonthReset !== currentMonth || currentUser.lastYearReset !== currentYear) {
                // Reset mensal
                if (currentUser.lastMonthReset !== currentMonth) {
                    currentUser.monthlyPoints = 0;
                    currentUser.lastMonthReset = currentMonth;
                    
                    // Reset desafios mensais
                    if (currentUser.challenges) {
                        currentUser.challenges.monthly.sales.current = 0;
                        currentUser.challenges.monthly.points.current = 0;
                    }
                    
                    showNotification('🗓️ Novo mês iniciado! Pontos mensais resetados.', 'info');
                }
                
                // Reset anual (se necessário)
                if (currentUser.lastYearReset !== currentYear) {
                    currentUser.lastYearReset = currentYear;
                    // Manter histórico mas resetar desafios anuais se houver
                }
                
                saveUserData();
            }
            
            // Verificar reset semanal para desafios
            const currentWeek = getWeekId();
            if (currentUser.lastWeekReset !== currentWeek) {
                currentUser.lastWeekReset = currentWeek;
                
                // Reset desafios semanais
                if (currentUser.challenges) {
                    currentUser.challenges.weekly.miyosmart.current = 0;
                    currentUser.challenges.weekly.variety.current = 0;
                    currentUser.challenges.weekly.premium.current = 0;
                    currentUser.challenges.weekly.sensity.current = 0;
                }
                
                // Limpar desafios completados da semana anterior
                if (currentUser.completedChallenges) {
                    currentUser.completedChallenges = currentUser.completedChallenges.filter(id => 
                        !id.includes('miyosmart-') && !id.includes('variety-') && 
                        !id.includes('premium-') && !id.includes('sensity-')
                    );
                }
                
                saveUserData();
            }
            
            // Inicializar campos se não existirem
            if (currentUser.salesPoints === undefined) currentUser.salesPoints = 0;
            if (currentUser.monthlyPoints === undefined) currentUser.monthlyPoints = 0;
            if (currentUser.profilePhoto === undefined) currentUser.profilePhoto = null;
            if (currentUser.username === undefined) {
                currentUser.username = currentUser.name.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
            }
            if (currentUser.hoyaCode === undefined) currentUser.hoyaCode = '';
            if (currentUser.achievements === undefined) currentUser.achievements = [];
            if (currentUser.completedChallenges === undefined) currentUser.completedChallenges = [];
            if (currentUser.unreadMessages === undefined) currentUser.unreadMessages = 2; // Mensagens de boas-vindas
            
            // Inicializar arrays de pontos categorizados
            if (currentUser.challengePoints === undefined) currentUser.challengePoints = [];
            if (currentUser.rankPoints === undefined) currentUser.rankPoints = [];
            if (currentUser.coursePoints === undefined) currentUser.coursePoints = [];
            
            // Recalcular desafios baseado nas vendas atuais
            recalculateChallenges();
            
            // Atualizar foto do perfil
            updateProfilePhoto();
        }
        
        // Função para recalcular desafios baseado nas vendas existentes
        function recalculateChallenges() {
            if (!currentUser.challenges) {
                currentUser.challenges = initializeChallenges();
            }
            
            // Recalcular desafios semanais
            const weekSales = getWeekSales();
            currentUser.challenges.weekly.miyosmart.current = weekSales.filter(s => s.lensType === 'MiYoSmart').length;
            currentUser.challenges.weekly.sensity.current = weekSales.filter(s => s.sensity !== 'none').length;
            currentUser.challenges.weekly.premium.current = weekSales.filter(s => s.material === '1.74 EYVIA').length;
            
            const uniqueTypes = [...new Set(weekSales.map(s => s.lensType))];
            currentUser.challenges.weekly.variety.current = uniqueTypes.length;
            
            // Recalcular desafios mensais
            const monthSales = getMonthSalesArray();
            currentUser.challenges.monthly.sales.current = monthSales.length;
            currentUser.challenges.monthly.points.current = getMonthPoints();
            currentUser.challenges.monthly.photosensitive.current = monthSales.filter(s => s.sensity !== 'none').length;
            currentUser.challenges.monthly.antireflective.current = monthSales.filter(s => 
                s.antiReflective === 'Meiryo' || s.antiReflective === 'AR MiYoSmart'
            ).length;
            
            // Recalcular desafios trimestrais
            const quarterSales = getQuarterSalesArray();
            if (!currentUser.challenges.quarterly.lifestyle) {
                currentUser.challenges.quarterly.lifestyle = { current: 0, target: 8, reward: 800, name: 'LifeStyle Trimestral' };
            }
            currentUser.challenges.quarterly.lifestyle.current = quarterSales.filter(s => s.lensType === 'Lifestyle').length;
            currentUser.challenges.quarterly.myself.current = quarterSales.filter(s => s.lensType === 'Myself').length;
        }
        
        function updateProfilePhoto() {
            if (!currentUser) return;
            
            const profileIcon = document.getElementById('profileIcon');
            const profileIconDesktop = document.getElementById('profileIconDesktop');
            const profileModalIcon = document.getElementById('profileModalIcon');
            
            if (currentUser.profilePhoto) {
                if (profileIcon) profileIcon.innerHTML = `<img src="${currentUser.profilePhoto}" alt="Foto" class="w-full h-full rounded-full object-cover">`;
                if (profileIconDesktop) profileIconDesktop.innerHTML = `<img src="${currentUser.profilePhoto}" alt="Foto" class="w-full h-full rounded-full object-cover">`;
                if (profileModalIcon) profileModalIcon.innerHTML = `<img src="${currentUser.profilePhoto}" alt="Foto" class="w-full h-full rounded-lg object-cover">`;
            } else {
                if (profileIcon) profileIcon.innerHTML = '<span class="text-lg">👤</span>';
                if (profileIconDesktop) profileIconDesktop.innerHTML = '<span class="text-lg">👤</span>';
                if (profileModalIcon) profileModalIcon.innerHTML = '👤';
            }
        }

        // Funções de autenticação
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('forgotForm').classList.add('hidden');
        }

        function showForgotPassword() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotForm').classList.remove('hidden');
        }

        function login() {
            const emailOrUsername = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;

            if (!emailOrUsername || !password) {
                showNotification('Por favor, preencha todos os campos!', 'error');
                return;
            }

            // Buscar por email ou username
            const foundUser = users.find(u => 
                (u.email === emailOrUsername || u.username === emailOrUsername) && u.password === password
            );

            if (foundUser) {
                currentUser = foundUser;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainSystem').classList.remove('hidden');
                setupUserInterface();
                updateUserInterface();
                showTab('home');
                
                // Garantir carregamento completo dos dados da home
                const forceHomeUpdate = () => {
                    updateActiveChallenges();
                    updateRecentSales();
                    updateDashboard();
                    updateHomeTabData();
                };
                
                // Múltiplas chamadas para garantir carregamento
                forceHomeUpdate();
                
                requestAnimationFrame(() => {
                    forceHomeUpdate();
                });
                
                setTimeout(() => {
                    forceHomeUpdate();
                }, 100);
                
                setTimeout(() => {
                    forceHomeUpdate();
                }, 300);
                
                showNotification(`Bem-vindo(a), ${foundUser.name}!`, 'success');
            } else {
                showNotification('Email/usuário ou senha incorretos!', 'error');
                document.getElementById('loginPassword').value = '';
            }
        }

        function register() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim().toLowerCase();
            const phone = document.getElementById('regPhone').value.trim();
            const optica = document.getElementById('regOptica').value.trim();
            const city = document.getElementById('regCity').value.trim();
            const hoyaCode = document.getElementById('regHoyaCode').value.trim();
            const func = document.getElementById('regFunction').value;
            const password = document.getElementById('regPassword').value;

            if (!name || !email || !phone || !optica || !city || !hoyaCode || !func || !password) {
                showNotification('Por favor, preencha todos os campos!', 'error');
                return;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showNotification('Por favor, digite um email válido!', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('A senha deve ter pelo menos 6 caracteres!', 'error');
                return;
            }

            if (users.find(u => u.email === email)) {
                showNotification('Este email já está cadastrado!', 'error');
                return;
            }

            // Gerar username baseado no nome
            const username = name.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');

            const newUser = {
                id: users.length + 1,
                email: email,
                username: username,
                password: password,
                name: name,
                phone: phone,
                optica: optica,
                city: city,
                hoyaCode: hoyaCode,
                function: func,
                points: 0,
                salesPoints: 0,
                monthlyPoints: 0,
                sales: [],
                certificates: [],
                unlockedRanks: ['Consultor Iniciante'],
                challenges: initializeChallenges(),
                profilePhoto: null,
                lastMonthReset: new Date().getMonth(),
                isSystemUser: false
            };

            users.push(newUser);
            currentUser = newUser;
            saveUserData();
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            setupUserInterface();
            updateUserInterface();
            showTab('home');
            
            // Garantir carregamento completo dos dados da home
            const forceHomeUpdate = () => {
                updateActiveChallenges();
                updateRecentSales();
                updateDashboard();
                updateHomeTabData();
            };
            
            // Múltiplas chamadas para garantir carregamento
            forceHomeUpdate();
            
            requestAnimationFrame(() => {
                forceHomeUpdate();
            });
            
            setTimeout(() => {
                forceHomeUpdate();
            }, 100);
            
            setTimeout(() => {
                forceHomeUpdate();
            }, 300);
            
            showNotification(`Cadastro realizado com sucesso! Bem-vindo(a), ${name}!`, 'success');
        }

        function resetPassword() {
            const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
            
            if (!email) {
                showNotification('Por favor, digite seu email!', 'error');
                return;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showNotification('Por favor, digite um email válido!', 'error');
                return;
            }

            const user = users.find(u => u.email === email);
            if (user) {
                showNotification(`Instruções de recuperação enviadas para ${email}`, 'success');
                showLogin();
            } else {
                showNotification('Email não encontrado em nossa base de dados!', 'error');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainSystem').classList.add('hidden');
            
            // Limpar campos
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            showLogin();
        }

        // Função para calcular pontos totais reais
        function calculateRealTotalPoints() {
            if (!currentUser) return 0;
            
            let totalPoints = 0;
            
            // 1. Pontos de vendas
            if (currentUser.sales) {
                totalPoints += currentUser.sales.reduce((sum, sale) => sum + (sale.points || 0), 0);
            }
            
            // 2. Pontos de desafios
            if (currentUser.challengePoints) {
                totalPoints += currentUser.challengePoints.reduce((sum, challenge) => sum + (challenge.points || 0), 0);
            }
            
            // 3. Pontos de patentes
            if (currentUser.rankPoints) {
                totalPoints += currentUser.rankPoints.reduce((sum, rank) => sum + (rank.points || 0), 0);
            }
            
            // 4. Pontos de cursos/certificados
            if (currentUser.coursePoints) {
                totalPoints += currentUser.coursePoints.reduce((sum, course) => sum + (course.points || 0), 0);
            }
            
            // NÃO somar achievements pois eles já estão incluídos nas outras categorias
            // Os achievements são apenas registros históricos, não pontos extras
            
            return totalPoints;
        }

        // Funções da interface
        function updateUserInterface() {
            if (!currentUser) return;

            // Calcular pontos totais reais (todas as categorias)
            const realTotalPoints = calculateRealTotalPoints();
            
            // Atualizar pontos totais se houver discrepância
            if (currentUser.points !== realTotalPoints) {
                currentUser.points = realTotalPoints;
                saveUserData();
            }

            // Mobile header
            document.getElementById('totalPoints').textContent = currentUser.points.toLocaleString('pt-BR');
            document.getElementById('currentRank').textContent = getCurrentRank(currentUser.salesPoints || 0);
            
            // Mobile header específico
            const welcomeMobile = document.getElementById('welcomeMessageMobile');
            const userInfoMobile = document.getElementById('userInfoMobile');
            
            if (welcomeMobile) welcomeMobile.textContent = `Olá, ${currentUser.name.split(' ')[0]}!`;
            if (userInfoMobile) userInfoMobile.textContent = `${currentUser.optica}`;
            
            // Desktop header
            const welcomeDesktop = document.getElementById('welcomeMessageDesktop');
            const userInfoDesktop = document.getElementById('userInfoDesktop');
            const totalPointsDesktop = document.getElementById('totalPointsDesktop');
            const currentRankDesktop = document.getElementById('currentRankDesktop');
            
            if (welcomeDesktop) welcomeDesktop.textContent = `Bem-vindo, ${currentUser.name}!`;
            if (userInfoDesktop) userInfoDesktop.textContent = `${currentUser.function} - ${currentUser.optica}`;
            if (totalPointsDesktop) totalPointsDesktop.textContent = currentUser.points.toLocaleString('pt-BR');
            if (currentRankDesktop) currentRankDesktop.textContent = getCurrentRank(currentUser.salesPoints || 0);
            
            // Home tab cards - sync with real data
            document.getElementById('homePoints').textContent = currentUser.points.toLocaleString('pt-BR');
            document.getElementById('monthSales').textContent = getMonthSales();
            document.getElementById('totalSales').textContent = currentUser.sales ? currentUser.sales.length : 0;
            document.getElementById('rankPosition').textContent = getRankPosition() > 0 ? `${getRankPosition()}º` : '-';
            
            updateDashboard();
            updateRanking();
            updateMessagesBadge();
        }

        function updateDashboard() {
            if (!currentUser) return;

            // Data is already updated in updateUserInterface()
            updateRecentSales();
            updateActiveChallenges();
        }

        function updateRecentSales() {
            const recentSalesDiv = document.getElementById('recentSales');
            const recentSales = currentUser.sales.slice(-5).reverse();

            if (recentSales.length === 0) {
                recentSalesDiv.innerHTML = '<p class="text-blue-200 text-center py-8">Nenhuma venda registrada ainda</p>';
                return;
            }

            recentSalesDiv.innerHTML = recentSales.map(sale => `
                <div class="glass-effect p-3 rounded-lg hover-glow">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-white font-semibold">${sale.client}</p>
                            <p class="text-blue-200 text-sm">${sale.lensType}</p>
                            <p class="text-blue-300 text-xs">${formatDate(sale.date)}</p>
                        </div>
                        <div class="text-right">
                            <p class="orbitron text-green-400 font-bold">+${sale.points} pts</p>
                            <p class="text-blue-300 text-xs">${sale.orderId}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateActiveChallenges() {
            const challengesDiv = document.getElementById('activeChallenges');
            
            if (!currentUser || !currentUser.challenges) {
                challengesDiv.innerHTML = '<p class="text-blue-200 text-center py-6 text-sm">Nenhum desafio ativo</p>';
                return;
            }
            
            challengesDiv.innerHTML = `
                <!-- Título dos Desafios Semanais -->
                <div class="mb-3">
                    <h4 class="text-white font-bold text-sm mb-2 flex items-center">
                        <span class="text-lg mr-2">⚡</span>
                        DESAFIOS SEMANAIS
                    </h4>
                </div>
                
                <!-- Desafios Semanais em Grid 2x2 -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="glass-effect p-2 rounded-lg">
                        <div class="text-center">
                            <p class="text-blue-200 font-semibold text-xs mb-1">MiYoSmart</p>
                            <p class="orbitron text-white font-bold text-sm">${currentUser.challenges.weekly.miyosmart.current}/${currentUser.challenges.weekly.miyosmart.target}</p>
                            <div class="bg-black/30 rounded-full h-1.5 my-1">
                                <div class="bg-gradient-to-r from-green-500 to-emerald-400 h-1.5 rounded-full progress-bar" style="width: ${(currentUser.challenges.weekly.miyosmart.current / currentUser.challenges.weekly.miyosmart.target) * 100}%"></div>
                            </div>
                            <p class="text-xs text-blue-200">${currentUser.challenges.weekly.miyosmart.target} vendas = +${currentUser.challenges.weekly.miyosmart.reward} pts</p>
                        </div>
                    </div>
                    
                    <div class="glass-effect p-2 rounded-lg">
                        <div class="text-center">
                            <p class="text-blue-200 font-semibold text-xs mb-1">Variedade</p>
                            <p class="orbitron text-white font-bold text-sm">${currentUser.challenges.weekly.variety.current}/${currentUser.challenges.weekly.variety.target}</p>
                            <div class="bg-black/30 rounded-full h-1.5 my-1">
                                <div class="bg-gradient-to-r from-purple-500 to-pink-400 h-1.5 rounded-full progress-bar" style="width: ${(currentUser.challenges.weekly.variety.current / currentUser.challenges.weekly.variety.target) * 100}%"></div>
                            </div>
                            <p class="text-xs text-blue-200">${currentUser.challenges.weekly.variety.target} tipos diferentes = +${currentUser.challenges.weekly.variety.reward} pts</p>
                        </div>
                    </div>
                    
                    <div class="glass-effect p-2 rounded-lg">
                        <div class="text-center">
                            <p class="text-blue-200 font-semibold text-xs mb-1">Premium 1.74</p>
                            <p class="orbitron text-white font-bold text-sm">${currentUser.challenges.weekly.premium.current}/${currentUser.challenges.weekly.premium.target}</p>
                            <div class="bg-black/30 rounded-full h-1.5 my-1">
                                <div class="bg-gradient-to-r from-yellow-500 to-orange-400 h-1.5 rounded-full progress-bar" style="width: ${(currentUser.challenges.weekly.premium.current / currentUser.challenges.weekly.premium.target) * 100}%"></div>
                            </div>
                            <p class="text-xs text-blue-200">${currentUser.challenges.weekly.premium.target} lentes = +${currentUser.challenges.weekly.premium.reward} pts</p>
                        </div>
                    </div>
                    
                    <div class="glass-effect p-2 rounded-lg">
                        <div class="text-center">
                            <p class="text-blue-200 font-semibold text-xs mb-1">Sensity</p>
                            <p class="orbitron text-white font-bold text-sm">${currentUser.challenges.weekly.sensity.current}/${currentUser.challenges.weekly.sensity.target}</p>
                            <div class="bg-black/30 rounded-full h-1.5 my-1">
                                <div class="bg-gradient-to-r from-indigo-500 to-teal-400 h-1.5 rounded-full progress-bar" style="width: ${(currentUser.challenges.weekly.sensity.current / currentUser.challenges.weekly.sensity.target) * 100}%"></div>
                            </div>
                            <p class="text-xs text-blue-200">${currentUser.challenges.weekly.sensity.target} lentes fotossensíveis = +${currentUser.challenges.weekly.sensity.reward} pts</p>
                        </div>
                    </div>
                </div>
                
                <!-- Título dos Desafios Mensais -->
                <div class="mb-3">
                    <h4 class="text-white font-bold text-sm mb-2 flex items-center">
                        <span class="text-lg mr-2">📅</span>
                        DESAFIOS MENSAIS
                    </h4>
                </div>
                
                <!-- Desafios Mensais em Grid 2x2 -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="glass-effect p-2 rounded-lg">
                        <div class="text-center">
                            <p class="text-blue-200 font-semibold text-xs mb-1">Meta Pontos</p>
                            <p class="orbitron text-white font-bold text-sm">${currentUser.challenges.monthly.points.current}/${currentUser.challenges.monthly.points.target}</p>
                            <div class="bg-black/30 rounded-full h-1.5 my-1">
                                <div class="bg-gradient-to-r from-blue-500 to-cyan-400 h-1.5 rounded-full progress-bar" style="width: ${(currentUser.challenges.monthly.points.current / currentUser.challenges.monthly.points.target) * 100}%"></div>
                            </div>
                            <p class="text-xs text-blue-200">${currentUser.challenges.monthly.points.target.toLocaleString('pt-BR')} pts = +${currentUser.challenges.monthly.points.reward} pts</p>
                        </div>
                    </div>
                    
                    <div class="glass-effect p-2 rounded-lg">
                        <div class="text-center">
                            <p class="text-blue-200 font-semibold text-xs mb-1">Meta Vendas</p>
                            <p class="orbitron text-white font-bold text-sm">${currentUser.challenges.monthly.sales.current}/${currentUser.challenges.monthly.sales.target}</p>
                            <div class="bg-black/30 rounded-full h-1.5 my-1">
                                <div class="bg-gradient-to-r from-red-500 to-pink-400 h-1.5 rounded-full progress-bar" style="width: ${(currentUser.challenges.monthly.sales.current / currentUser.challenges.monthly.sales.target) * 100}%"></div>
                            </div>
                            <p class="text-xs text-blue-200">${currentUser.challenges.monthly.sales.target} vendas = +${currentUser.challenges.monthly.sales.reward} pts</p>
                        </div>
                    </div>
                    
                    <div class="glass-effect p-2 rounded-lg">
                        <div class="text-center">
                            <p class="text-blue-200 font-semibold text-xs mb-1">Meta Sensity</p>
                            <p class="orbitron text-white font-bold text-sm">${currentUser.challenges.monthly.photosensitive.current}/${currentUser.challenges.monthly.photosensitive.target}</p>
                            <div class="bg-black/30 rounded-full h-1.5 my-1">
                                <div class="bg-gradient-to-r from-orange-500 to-yellow-400 h-1.5 rounded-full progress-bar" style="width: ${(currentUser.challenges.monthly.photosensitive.current / currentUser.challenges.monthly.photosensitive.target) * 100}%"></div>
                            </div>
                            <p class="text-xs text-blue-200">${currentUser.challenges.monthly.photosensitive.target} lentes = +${currentUser.challenges.monthly.photosensitive.reward} pts</p>
                        </div>
                    </div>
                    
                    <div class="glass-effect p-2 rounded-lg">
                        <div class="text-center">
                            <p class="text-blue-200 font-semibold text-xs mb-1">Antirreflexo</p>
                            <p class="orbitron text-white font-bold text-sm">${currentUser.challenges.monthly.antireflective.current}/${currentUser.challenges.monthly.antireflective.target}</p>
                            <div class="bg-black/30 rounded-full h-1.5 my-1">
                                <div class="bg-gradient-to-r from-pink-500 to-purple-400 h-1.5 rounded-full progress-bar" style="width: ${(currentUser.challenges.monthly.antireflective.current / currentUser.challenges.monthly.antireflective.target) * 100}%"></div>
                            </div>
                            <p class="text-xs text-blue-200">${currentUser.challenges.monthly.antireflective.target} Meiryo/AR = +${currentUser.challenges.monthly.antireflective.reward} pts</p>
                        </div>
                    </div>
                </div>
                
                <!-- Título dos Desafios Trimestrais -->
                <div class="mb-3">
                    <h4 class="text-white font-bold text-sm mb-2 flex items-center">
                        <span class="text-lg mr-2">🏆</span>
                        DESAFIOS TRIMESTRAIS
                    </h4>
                </div>
                
                <!-- Desafios Trimestrais em Grid 1x2 -->
                <div class="grid grid-cols-2 gap-2">
                    <div class="glass-effect p-2 rounded-lg">
                        <div class="text-center">
                            <p class="text-blue-200 font-semibold text-xs mb-1">LifeStyle</p>
                            <p class="orbitron text-white font-bold text-sm">${currentUser.challenges.quarterly.lifestyle ? currentUser.challenges.quarterly.lifestyle.current : 0}/${currentUser.challenges.quarterly.lifestyle ? currentUser.challenges.quarterly.lifestyle.target : 8}</p>
                            <div class="bg-black/30 rounded-full h-1.5 my-1">
                                <div class="bg-gradient-to-r from-cyan-500 to-blue-400 h-1.5 rounded-full progress-bar" style="width: ${currentUser.challenges.quarterly.lifestyle ? (currentUser.challenges.quarterly.lifestyle.current / currentUser.challenges.quarterly.lifestyle.target) * 100 : 0}%"></div>
                            </div>
                            <p class="text-xs text-blue-200">8 vendas = +800 pts</p>
                        </div>
                    </div>
                    
                    <div class="glass-effect p-2 rounded-lg">
                        <div class="text-center">
                            <p class="text-blue-200 font-semibold text-xs mb-1">MySelf</p>
                            <p class="orbitron text-white font-bold text-sm">${currentUser.challenges.quarterly.myself.current}/${currentUser.challenges.quarterly.myself.target}</p>
                            <div class="bg-black/30 rounded-full h-1.5 my-1">
                                <div class="bg-gradient-to-r from-teal-500 to-green-400 h-1.5 rounded-full progress-bar" style="width: ${(currentUser.challenges.quarterly.myself.current / currentUser.challenges.quarterly.myself.target) * 100}%"></div>
                            </div>
                            <p class="text-xs text-blue-200">${currentUser.challenges.quarterly.myself.target} vendas = +${currentUser.challenges.quarterly.myself.reward} pts</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Variáveis para seleção de produtos
        let selectedProducts = {
            lensType: null,
            antiReflective: 'none',
            sensity: 'none',
            material: null
        };

        // Funções de navegação
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const targetTab = document.getElementById(`tab-${tabName}`);
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
            
            const activeNavTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeNavTab) {
                activeNavTab.classList.add('active');
            }
            
            if (tabName === 'home') {
                updateHomeTabData();
            } else if (tabName === 'desempenho') {
                updateSalesTable();
                updatePerformanceMetrics();
            } else if (tabName === 'ranking') {
                updateRanking();
            } else if (tabName === 'patentes') {
                loadRanks();
            } else if (tabName === 'cursos') {
                loadTrainings();
            } else if (tabName === 'premios') {
                updatePrizesTab();
            } else if (tabName === 'vendas') {
                loadProductDropdowns();
            }
        }

        // Carregar produtos nos dropdowns
        function loadProductDropdowns() {
            loadLensTypeDropdown();
            loadAntiReflectiveDropdown();
            loadSensityDropdown();
            loadMaterialDropdown();
        }

        function loadLensTypeDropdown() {
            const select = document.getElementById('saleLensType');
            const lensTypes = [
                { name: 'MiYoSmart', points: 100 },
                { name: 'Myself', points: 90 },
                { name: 'MyStyle', points: 80 },
                { name: 'WorkStyle', points: 70 },
                { name: 'Lifestyle', points: 70 },
                { name: 'Enroute', points: 60 },
                { name: 'Balanssis', points: 60 },
                { name: 'Daynamic', points: 50 },
                { name: 'Sync', points: 40 },
                { name: 'Nulux ID V+', points: 40 },
                { name: 'Nulux trueform', points: 30 },
                { name: 'Maxxee', points: 20 },
                { name: 'Nulux surfaçadas', points: 15 },
                { name: 'Hilux surfaçadas', points: 15 },
                { name: 'Nulux Visão Simples', points: 10 },
                { name: 'Hilux Visão Simples', points: 10 }
            ];

            // Organizar em grupos de 3x3 (9 por grupo)
            const groups = [];
            for (let i = 0; i < lensTypes.length; i += 9) {
                groups.push(lensTypes.slice(i, i + 9));
            }

            let optionsHTML = '<option value="">Selecione o tipo de lente</option>';
            groups.forEach((group, groupIndex) => {
                optionsHTML += `<optgroup label="━━━ GRUPO ${groupIndex + 1} ━━━">`;
                group.forEach(lens => {
                    optionsHTML += `<option value="${lens.name}">${lens.name} (+${lens.points} pts)</option>`;
                });
                optionsHTML += '</optgroup>';
            });

            select.innerHTML = optionsHTML;
        }

        function loadAntiReflectiveDropdown() {
            const select = document.getElementById('saleAntiReflective');
            const treatments = [
                { name: 'none', display: 'Sem Tratamento', points: 0 },
                { name: 'Meiryo', points: 70 },
                { name: 'AR MiYoSmart', points: 70 },
                { name: 'SunPro', points: 60 },
                { name: 'LongLife', points: 50 },
                { name: 'BlueControl', points: 40 },
                { name: 'NoRisk', points: 30 }
            ];

            let optionsHTML = '<option value="none">Sem tratamento antirreflexo (Grátis)</option>';
            treatments.slice(1).forEach(treatment => {
                optionsHTML += `<option value="${treatment.name}">${treatment.name} (+${treatment.points} pts)</option>`;
            });

            select.innerHTML = optionsHTML;
        }

        function loadSensityDropdown() {
            const select = document.getElementById('saleSensity');
            const sensityOptions = [
                { name: 'none', display: 'Sem Sensity', points: 0 },
                { name: 'Chameleon', points: 70 },
                { name: 'Sensity Shine', points: 60 },
                { name: 'Sensity Dark', points: 55 },
                { name: 'Sensity Fast', points: 50 },
                { name: 'Sensity 2', points: 45 },
                { name: 'Sensity Original', points: 40 }
            ];

            let optionsHTML = '<option value="none">Sem Sensity (Grátis)</option>';
            sensityOptions.slice(1).forEach(sensity => {
                optionsHTML += `<option value="${sensity.name}">${sensity.name} (+${sensity.points} pts)</option>`;
            });

            select.innerHTML = optionsHTML;
        }

        function loadMaterialDropdown() {
            const select = document.getElementById('saleMaterial');
            const materials = [
                { name: '', display: 'Sem Material', points: 0 },
                { name: '1.74 EYVIA', points: 70 },
                { name: '1.67 EYNOA', points: 60 },
                { name: '1.60 EYAS 2.0', points: 50 },
                { name: '1.59 POLI', points: 40 },
                { name: '1.53 PNX', points: 35 },
                { name: '1.50 ORGANIC', points: 30 }
            ];

            let optionsHTML = '<option value="">Sem material específico (Grátis)</option>';
            materials.slice(1).forEach(material => {
                optionsHTML += `<option value="${material.name}">${material.name} (+${material.points} pts)</option>`;
            });

            select.innerHTML = optionsHTML;
        }

        // Função para atualizar produto selecionado
        function updateSelectedProduct(type, value) {
            selectedProducts[type] = value;
            calculatePoints();
        }

        // Funções de vendas
        function calculatePoints() {
            const lensType = document.getElementById('saleLensType').value;
            const antiReflective = document.getElementById('saleAntiReflective').value;
            const sensity = document.getElementById('saleSensity').value;
            const material = document.getElementById('saleMaterial').value;
            
            let totalPoints = 0;
            let breakdown = [];
            
            if (lensType && lensPoints[lensType]) {
                totalPoints += lensPoints[lensType];
                breakdown.push(`${lensType}: +${lensPoints[lensType]} pts`);
            }
            
            if (antiReflective !== 'none' && extraPoints.antiReflective[antiReflective]) {
                totalPoints += extraPoints.antiReflective[antiReflective];
                breakdown.push(`${antiReflective}: +${extraPoints.antiReflective[antiReflective]} pts`);
            }
            
            if (sensity !== 'none' && extraPoints.sensity[sensity]) {
                totalPoints += extraPoints.sensity[sensity];
                breakdown.push(`${sensity}: +${extraPoints.sensity[sensity]} pts`);
            }
            
            if (material && extraPoints.material[material]) {
                totalPoints += extraPoints.material[material];
                breakdown.push(`${material}: +${extraPoints.material[material]} pts`);
            }
            
            document.getElementById('totalPointsPreview').textContent = totalPoints;
            
            const breakdownDiv = document.getElementById('pointsBreakdown');
            if (breakdown.length > 0) {
                breakdownDiv.innerHTML = breakdown.map(item => `<p>• ${item}</p>`).join('');
            } else {
                breakdownDiv.innerHTML = '<p>Selecione os produtos para ver a pontuação</p>';
            }
        }

        function registerSale() {
            if (!currentUser) return;
            
            const client = document.getElementById('saleClient').value.trim();
            const orderId = document.getElementById('saleOrderId').value.trim();
            const date = document.getElementById('saleDate').value;
            const lensType = document.getElementById('saleLensType').value;
            const antiReflective = document.getElementById('saleAntiReflective').value;
            const sensity = document.getElementById('saleSensity').value;
            const material = document.getElementById('saleMaterial').value;
            
            if (!client || !orderId || !date || !lensType) {
                showNotification('Por favor, preencha todos os campos obrigatórios!', 'error');
                return;
            }
            
            // Verificar se o ID já existe (validação rigorosa)
            const allSales = users.flatMap(u => u.sales || []);
            const existingSale = allSales.find(sale => sale.orderId === orderId);
            if (existingSale) {
                const existingUser = users.find(u => u.sales && u.sales.includes(existingSale));
                showNotification(`ID do pedido já foi registrado por ${existingUser ? existingUser.name : 'outro usuário'}!`, 'error');
                return;
            }
            
            // Verificar vendas muito próximas (mesmo cliente, mesmo dia)
            const todaySales = currentUser.sales.filter(sale => sale.date === date);
            const duplicateClient = todaySales.find(sale => 
                sale.client.toLowerCase().trim() === client.toLowerCase().trim()
            );
            if (duplicateClient) {
                if (!confirm(`Já existe uma venda para ${client} hoje. Confirma o registro de uma nova venda?`)) {
                    return;
                }
            }
            
            let totalPoints = 0;
            let products = [lensType];
            
            if (lensType && lensPoints[lensType]) {
                totalPoints += lensPoints[lensType];
            }
            
            if (antiReflective !== 'none' && extraPoints.antiReflective[antiReflective]) {
                totalPoints += extraPoints.antiReflective[antiReflective];
                products.push(antiReflective);
            }
            
            if (sensity !== 'none' && extraPoints.sensity[sensity]) {
                totalPoints += extraPoints.sensity[sensity];
                products.push(sensity);
            }
            
            if (material && extraPoints.material[material]) {
                totalPoints += extraPoints.material[material];
                products.push(material);
            }
            
            const sale = {
                id: Date.now(),
                client: client,
                orderId: orderId,
                date: date,
                lensType: lensType,
                antiReflective: antiReflective,
                sensity: sensity,
                material: material,
                products: products,
                points: totalPoints,
                timestamp: new Date().toISOString()
            };
            
            currentUser.sales.push(sale);
            currentUser.points += totalPoints;
            currentUser.salesPoints += totalPoints; // Pontos apenas de vendas para patentes
            currentUser.monthlyPoints += totalPoints;
            
            // Atualizar ranking mensal
            updateMonthlyRanking();
            
            // Enviar mensagem de parabéns pela venda
            sendSaleCongratulatoryMessage(sale);
            
            // Atualizar desafios
            updateChallengeProgress(sale);
            
            // Verificar novas patentes (apenas com salesPoints)
            checkRankUnlock();
            
            // Verificar conquistas automáticas
            checkAchievements(sale);
            
            // Enviar mensagens de progresso
            sendChallengeProgressMessage();
            sendRankProgressMessage();
            sendRankingPositionMessage();
            
            saveUserData();
            updateUserInterface();
            
            // Atualizar dados em tempo real na aba home
            updateHomeTabData();
            
            // Limpar formulário completamente - FORÇAR reset completo
            const clientField = document.getElementById('saleClient');
            const orderField = document.getElementById('saleOrderId');
            const dateField = document.getElementById('saleDate');
            const lensField = document.getElementById('saleLensType');
            const antiField = document.getElementById('saleAntiReflective');
            const sensityField = document.getElementById('saleSensity');
            const materialField = document.getElementById('saleMaterial');
            
            // Limpar campos de texto
            clientField.value = '';
            orderField.value = '';
            
            // Definir data como hoje novamente
            const today = new Date().toISOString().split('T')[0];
            dateField.value = today;
            
            // Resetar dropdowns com valores corretos
            lensField.selectedIndex = 0; // Primeira opção (vazia)
            antiField.selectedIndex = 0; // "Sem tratamento antirreflexo"
            sensityField.selectedIndex = 0; // "Sem Sensity"
            materialField.selectedIndex = 0; // "Sem material específico"
            
            // Forçar atualização visual dos selects
            lensField.dispatchEvent(new Event('change'));
            antiField.dispatchEvent(new Event('change'));
            sensityField.dispatchEvent(new Event('change'));
            materialField.dispatchEvent(new Event('change'));
            
            // Resetar seleção de produtos
            selectedProducts = {
                lensType: null,
                antiReflective: 'none',
                sensity: 'none',
                material: null
            };
            
            // Limpar preview de pontos
            document.getElementById('totalPointsPreview').textContent = '0';
            document.getElementById('pointsBreakdown').innerHTML = '<p>Selecione os produtos para ver a pontuação</p>';
            
            // Forçar foco no primeiro campo para indicar que foi limpo
            setTimeout(() => {
                clientField.focus();
            }, 100);
            
            showNotification(`Venda registrada com sucesso! +${totalPoints} pontos`, 'success');
        }

        function updateChallengeProgress(sale) {
            if (!currentUser.challenges) {
                currentUser.challenges = initializeChallenges();
            }
            
            // Inicializar arrays de pontos categorizados se não existirem
            if (!currentUser.challengePoints) currentUser.challengePoints = [];

            // Verificar se desafios já foram completados para evitar pontos duplicados
            const completedChallenges = currentUser.completedChallenges || [];

            // Desafio MiYoSmart semanal
            if (sale.lensType === 'MiYoSmart') {
                currentUser.challenges.weekly.miyosmart.current++;
                const challengeId = `miyosmart-${getWeekId()}`;
                if (currentUser.challenges.weekly.miyosmart.current >= currentUser.challenges.weekly.miyosmart.target && !completedChallenges.includes(challengeId)) {
                    const reward = currentUser.challenges.weekly.miyosmart.reward;
                    currentUser.points += reward;
                    
                    // Registrar pontos de desafio
                    currentUser.challengePoints.push({
                        type: 'weekly_miyosmart',
                        points: reward,
                        date: new Date().toISOString(),
                        description: 'Desafio MiYoSmart Semanal'
                    });
                    
                    completedChallenges.push(challengeId);
                    showNotification(`🔥 Desafio MiYoSmart Semanal concluído! +${reward} pontos bônus!`, 'success');
                    sendChallengeCompletedMessage('weekly', 'MiYoSmart Semanal', reward);
                }
            }

            // Desafio Sensity semanal
            if (sale.sensity !== 'none') {
                currentUser.challenges.weekly.sensity.current++;
                const challengeId = `sensity-${getWeekId()}`;
                if (currentUser.challenges.weekly.sensity.current >= currentUser.challenges.weekly.sensity.target && !completedChallenges.includes(challengeId)) {
                    const reward = currentUser.challenges.weekly.sensity.reward;
                    currentUser.points += reward;
                    
                    // Registrar pontos de desafio
                    currentUser.challengePoints.push({
                        type: 'weekly_sensity',
                        points: reward,
                        date: new Date().toISOString(),
                        description: 'Desafio Sensity Semanal'
                    });
                    
                    completedChallenges.push(challengeId);
                    showNotification(`🌞 Desafio Sensity Semanal concluído! +${reward} pontos bônus!`, 'success');
                    sendChallengeCompletedMessage('weekly', 'Sensity Semanal', reward);
                }
            }

            // Desafio Premium 1.74 semanal
            if (sale.material === '1.74 EYVIA') {
                currentUser.challenges.weekly.premium.current++;
                const challengeId = `premium-${getWeekId()}`;
                if (currentUser.challenges.weekly.premium.current >= currentUser.challenges.weekly.premium.target && !completedChallenges.includes(challengeId)) {
                    const reward = currentUser.challenges.weekly.premium.reward;
                    currentUser.points += reward;
                    
                    // Registrar pontos de desafio
                    currentUser.challengePoints.push({
                        type: 'weekly_premium',
                        points: reward,
                        date: new Date().toISOString(),
                        description: 'Desafio Premium 1.74 Semanal'
                    });
                    
                    completedChallenges.push(challengeId);
                    showNotification(`💎 Desafio Premium 1.74 Semanal concluído! +${reward} pontos bônus!`, 'success');
                    sendChallengeCompletedMessage('weekly', 'Premium 1.74 Semanal', reward);
                }
            }

            // Desafio variedade semanal (tipos diferentes)
            const weekSales = getWeekSales();
            const uniqueTypes = [...new Set(weekSales.map(s => s.lensType))];
            currentUser.challenges.weekly.variety.current = uniqueTypes.length;
            const varietyId = `variety-${getWeekId()}`;
            if (currentUser.challenges.weekly.variety.current >= currentUser.challenges.weekly.variety.target && !completedChallenges.includes(varietyId)) {
                const reward = currentUser.challenges.weekly.variety.reward;
                currentUser.points += reward;
                
                // Registrar pontos de desafio
                currentUser.challengePoints.push({
                    type: 'weekly_variety',
                    points: reward,
                    date: new Date().toISOString(),
                    description: 'Desafio Variedade Semanal'
                });
                
                completedChallenges.push(varietyId);
                showNotification(`🌈 Desafio Variedade Semanal concluído! +${reward} pontos bônus!`, 'success');
                sendChallengeCompletedMessage('weekly', 'Variedade Semanal', reward);
            }

            // Desafios mensais
            const monthSalesArray = getMonthSalesArray();
            currentUser.challenges.monthly.sales.current = monthSalesArray.length;
            const monthlySalesId = `monthly-sales-${getMonthId()}`;
            if (currentUser.challenges.monthly.sales.current >= currentUser.challenges.monthly.sales.target && !completedChallenges.includes(monthlySalesId)) {
                const reward = currentUser.challenges.monthly.sales.reward;
                currentUser.points += reward;
                
                // Registrar pontos de desafio
                currentUser.challengePoints.push({
                    type: 'monthly_sales',
                    points: reward,
                    date: new Date().toISOString(),
                    description: 'Meta de Vendas Mensal'
                });
                
                completedChallenges.push(monthlySalesId);
                showNotification(`📅 Meta de Vendas Mensal concluída! +${reward} pontos bônus!`, 'success');
                sendChallengeCompletedMessage('monthly', 'Meta de Vendas Mensal', reward);
            }

            const monthPoints = getMonthPoints();
            currentUser.challenges.monthly.points.current = monthPoints;
            const monthlyPointsId = `monthly-points-${getMonthId()}`;
            if (currentUser.challenges.monthly.points.current >= currentUser.challenges.monthly.points.target && !completedChallenges.includes(monthlyPointsId)) {
                const reward = currentUser.challenges.monthly.points.reward;
                currentUser.points += reward;
                
                // Registrar pontos de desafio
                currentUser.challengePoints.push({
                    type: 'monthly_points',
                    points: reward,
                    date: new Date().toISOString(),
                    description: 'Meta de Pontos Mensal'
                });
                
                completedChallenges.push(monthlyPointsId);
                showNotification(`📊 Meta de Pontos Mensal concluída! +${reward} pontos bônus!`, 'success');
                sendChallengeCompletedMessage('monthly', 'Meta de Pontos Mensal', reward);
            }

            // Desafio Meta Sensity mensal
            currentUser.challenges.monthly.photosensitive.current = monthSalesArray.filter(s => s.sensity !== 'none').length;
            const monthlyPhotosensitiveId = `monthly-photosensitive-${getMonthId()}`;
            if (currentUser.challenges.monthly.photosensitive.current >= currentUser.challenges.monthly.photosensitive.target && !completedChallenges.includes(monthlyPhotosensitiveId)) {
                const reward = currentUser.challenges.monthly.photosensitive.reward;
                currentUser.points += reward;
                
                // Registrar pontos de desafio
                currentUser.challengePoints.push({
                    type: 'monthly_photosensitive',
                    points: reward,
                    date: new Date().toISOString(),
                    description: 'Meta Sensity Mensal'
                });
                
                completedChallenges.push(monthlyPhotosensitiveId);
                showNotification(`🌞 Meta Sensity Mensal concluída! +${reward} pontos bônus!`, 'success');
                sendChallengeCompletedMessage('monthly', 'Meta Sensity Mensal', reward);
            }

            // Desafio Antirreflexo mensal
            currentUser.challenges.monthly.antireflective.current = monthSalesArray.filter(s => 
                s.antiReflective === 'Meiryo' || s.antiReflective === 'AR MiYoSmart'
            ).length;
            const monthlyAntireflectiveId = `monthly-antireflective-${getMonthId()}`;
            if (currentUser.challenges.monthly.antireflective.current >= currentUser.challenges.monthly.antireflective.target && !completedChallenges.includes(monthlyAntireflectiveId)) {
                const reward = currentUser.challenges.monthly.antireflective.reward;
                currentUser.points += reward;
                
                // Registrar pontos de desafio
                currentUser.challengePoints.push({
                    type: 'monthly_antireflective',
                    points: reward,
                    date: new Date().toISOString(),
                    description: 'Desafio Antirreflexo Mensal'
                });
                
                completedChallenges.push(monthlyAntireflectiveId);
                showNotification(`✨ Desafio Antirreflexo Mensal concluído! +${reward} pontos bônus!`, 'success');
                sendChallengeCompletedMessage('monthly', 'Antirreflexo Mensal', reward);
            }

            // Desafio LifeStyle trimestral
            const quarterSalesArray = getQuarterSalesArray();
            if (!currentUser.challenges.quarterly.lifestyle) {
                currentUser.challenges.quarterly.lifestyle = { current: 0, target: 8, reward: 800, name: 'LifeStyle Trimestral' };
            }
            currentUser.challenges.quarterly.lifestyle.current = quarterSalesArray.filter(s => s.lensType === 'Lifestyle').length;
            const quarterlyLifestyleId = `quarterly-lifestyle-${getQuarterId()}`;
            if (currentUser.challenges.quarterly.lifestyle.current >= currentUser.challenges.quarterly.lifestyle.target && !completedChallenges.includes(quarterlyLifestyleId)) {
                const reward = currentUser.challenges.quarterly.lifestyle.reward;
                currentUser.points += reward;
                
                // Registrar pontos de desafio
                currentUser.challengePoints.push({
                    type: 'quarterly_lifestyle',
                    points: reward,
                    date: new Date().toISOString(),
                    description: 'Desafio LifeStyle Trimestral'
                });
                
                completedChallenges.push(quarterlyLifestyleId);
                showNotification(`🏆 Desafio LifeStyle Trimestral concluído! +${reward} pontos bônus!`, 'success');
                sendChallengeCompletedMessage('quarterly', 'LifeStyle Trimestral', reward);
            }

            // Desafio MySelf trimestral
            currentUser.challenges.quarterly.myself.current = quarterSalesArray.filter(s => s.lensType === 'Myself').length;
            const quarterlyMyselfId = `quarterly-myself-${getQuarterId()}`;
            if (currentUser.challenges.quarterly.myself.current >= currentUser.challenges.quarterly.myself.target && !completedChallenges.includes(quarterlyMyselfId)) {
                const reward = currentUser.challenges.quarterly.myself.reward;
                currentUser.points += reward;
                
                // Registrar pontos de desafio
                currentUser.challengePoints.push({
                    type: 'quarterly_myself',
                    points: reward,
                    date: new Date().toISOString(),
                    description: 'Desafio MySelf Trimestral'
                });
                
                completedChallenges.push(quarterlyMyselfId);
                showNotification(`🏆 Desafio MySelf Trimestral concluído! +${reward} pontos bônus!`, 'success');
                sendChallengeCompletedMessage('quarterly', 'MySelf Trimestral', reward);
            }

            currentUser.completedChallenges = completedChallenges;
            
            // Enviar mensagens de progresso dos desafios
            sendChallengeProgressMessages(sale);
        }

        // Função para enviar mensagens de progresso específicas da venda
        function sendChallengeProgressMessages(sale) {
            if (!currentUser || !currentUser.challenges) return;
            
            const challenges = currentUser.challenges;
            
            // Mensagem sobre o produto que acabou de registrar
            let productMessage = `🎯 Produto registrado: ${sale.lensType}`;
            if (sale.antiReflective !== 'none') productMessage += ` com ${sale.antiReflective}`;
            if (sale.sensity !== 'none') productMessage += ` e ${sale.sensity}`;
            if (sale.material) productMessage += ` em ${sale.material}`;
            
            addSystemMessage('📝 Venda Registrada', productMessage, 'sale');
            
            // Verificar progresso dos desafios relacionados ao produto vendido
            
            // MiYoSmart
            if (sale.lensType === 'MiYoSmart') {
                const remaining = challenges.weekly.miyosmart.target - challenges.weekly.miyosmart.current;
                if (remaining > 0) {
                    addSystemMessage(
                        '🔥 Progresso MiYoSmart',
                        `Excelente! Você vendeu MiYoSmart. Faltam ${remaining} vendas para completar o desafio semanal e ganhar +${challenges.weekly.miyosmart.reward} pontos!`,
                        'challenge'
                    );
                }
            }
            
            // Sensity/Fotossensível
            if (sale.sensity !== 'none') {
                // Desafio semanal
                const weeklyRemaining = challenges.weekly.sensity.target - challenges.weekly.sensity.current;
                if (weeklyRemaining > 0) {
                    addSystemMessage(
                        '🌞 Progresso Sensity Semanal',
                        `Ótimo! Você vendeu ${sale.sensity}. Faltam ${weeklyRemaining} lentes fotossensíveis para completar o desafio semanal (+${challenges.weekly.sensity.reward} pts)!`,
                        'challenge'
                    );
                }
                
                // Desafio mensal
                const monthlyRemaining = challenges.monthly.photosensitive.target - challenges.monthly.photosensitive.current;
                if (monthlyRemaining > 0) {
                    addSystemMessage(
                        '🌞 Progresso Meta Sensity Mensal',
                        `Perfeito! Faltam ${monthlyRemaining} lentes Sensity para completar o desafio mensal e ganhar +${challenges.monthly.photosensitive.reward} pontos!`,
                        'challenge'
                    );
                }
            }
            
            // Premium 1.74
            if (sale.material === '1.74 EYVIA') {
                const remaining = challenges.weekly.premium.target - challenges.weekly.premium.current;
                if (remaining > 0) {
                    addSystemMessage(
                        '💎 Progresso Premium 1.74',
                        `Excelente venda premium! Faltam ${remaining} lentes 1.74 EYVIA para completar o desafio semanal (+${challenges.weekly.premium.reward} pts)!`,
                        'challenge'
                    );
                }
            }
            
            // Antirreflexo
            if (sale.antiReflective === 'Meiryo' || sale.antiReflective === 'AR MiYoSmart') {
                const remaining = challenges.monthly.antireflective.target - challenges.monthly.antireflective.current;
                if (remaining > 0) {
                    addSystemMessage(
                        '✨ Progresso Antirreflexo',
                        `Ótima escolha de antirreflexo! Faltam ${remaining} vendas de Meiryo/AR MiYoSmart para completar o desafio mensal (+${challenges.monthly.antireflective.reward} pts)!`,
                        'challenge'
                    );
                }
            }
            
            // MySelf
            if (sale.lensType === 'Myself') {
                const remaining = challenges.quarterly.myself.target - challenges.quarterly.myself.current;
                if (remaining > 0) {
                    addSystemMessage(
                        '🏆 Progresso MySelf Trimestral',
                        `Excelente! Você vendeu MySelf. Faltam ${remaining} vendas para completar o desafio trimestral e ganhar +${challenges.quarterly.myself.reward} pontos!`,
                        'challenge'
                    );
                }
            }
            
            // Progresso geral dos desafios mensais
            const salesRemaining = challenges.monthly.sales.target - challenges.monthly.sales.current;
            if (salesRemaining > 0 && salesRemaining <= 10) {
                addSystemMessage(
                    '📅 Meta de Vendas Mensal',
                    `Você está próximo da meta! Faltam ${salesRemaining} vendas para completar o desafio mensal (+${challenges.monthly.sales.reward} pts)!`,
                    'challenge'
                );
            }
            
            const pointsRemaining = challenges.monthly.points.target - challenges.monthly.points.current;
            if (pointsRemaining > 0 && pointsRemaining <= 2000) {
                addSystemMessage(
                    '📊 Meta de Pontos Mensal',
                    `Quase lá! Faltam ${pointsRemaining} pontos para completar a meta mensal (+${challenges.monthly.points.reward} pts)!`,
                    'challenge'
                );
            }
        }

        // Funções auxiliares para IDs únicos de desafios
        function getWeekId() {
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const days = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000));
            return `${now.getFullYear()}-W${Math.ceil(days / 7)}`;
        }

        function getMonthId() {
            const now = new Date();
            return `${now.getFullYear()}-${now.getMonth()}`;
        }
        
        // Sistema de conquistas automáticas
        function checkAchievements(sale) {
            if (!currentUser.achievements) currentUser.achievements = [];
            
            const achievements = currentUser.achievements;
            const totalSales = currentUser.sales.length;
            
            // Conquistas por marcos de vendas (SEM PONTOS EXTRAS - apenas registro histórico)
            const salesMilestones = [
                { count: 1, name: 'Primeira Venda', icon: '🎯' },
                { count: 10, name: 'Vendedor Iniciante', icon: '📈' },
                { count: 25, name: 'Vendedor Experiente', icon: '🏆' },
                { count: 50, name: 'Vendedor Expert', icon: '⭐' },
                { count: 100, name: 'Vendedor Master', icon: '👑' },
                { count: 250, name: 'Vendedor Legend', icon: '🔥' },
                { count: 500, name: 'Vendedor Champion', icon: '💎' }
            ];
            
            salesMilestones.forEach(milestone => {
                if (totalSales >= milestone.count && !achievements.find(a => a.name === milestone.name)) {
                    achievements.push({
                        type: 'sales_milestone',
                        name: milestone.name,
                        icon: milestone.icon,
                        description: `${milestone.count} vendas realizadas`,
                        date: new Date().toISOString()
                    });
                    
                    // Apenas notificação, SEM pontos extras
                    showNotification(`🏆 CONQUISTA: ${milestone.name}!`, 'success');
                }
            });
            
            // Conquistas por produtos específicos (SEM PONTOS EXTRAS - apenas registro histórico)
            const productAchievements = [
                { product: 'MiYoSmart', count: 5, name: 'Especialista MiYoSmart', icon: '👁️' },
                { product: 'MiYoSmart', count: 20, name: 'Master MiYoSmart', icon: '🎓' },
                { material: '1.74 EYVIA', count: 10, name: 'Premium Expert', icon: '💎' },
                { sensity: true, count: 15, name: 'Transitions Master', icon: '🌞' }
            ];
            
            productAchievements.forEach(achievement => {
                let userCount = 0;
                
                if (achievement.product) {
                    userCount = currentUser.sales.filter(s => s.lensType === achievement.product).length;
                } else if (achievement.material) {
                    userCount = currentUser.sales.filter(s => s.material === achievement.material).length;
                } else if (achievement.sensity) {
                    userCount = currentUser.sales.filter(s => s.sensity !== 'none').length;
                }
                
                if (userCount >= achievement.count && !achievements.find(a => a.name === achievement.name)) {
                    achievements.push({
                        type: 'product_achievement',
                        name: achievement.name,
                        icon: achievement.icon,
                        description: `${achievement.count} vendas do produto`,
                        date: new Date().toISOString()
                    });
                    
                    // Apenas notificação, SEM pontos extras
                    showNotification(`🏆 CONQUISTA: ${achievement.name}!`, 'success');
                }
            });
            
            // Conquistas por sequências
            checkStreakAchievements();
        }
        
        function checkStreakAchievements() {
            if (!currentUser.achievements) currentUser.achievements = [];
            
            // Verificar sequência de dias consecutivos com vendas
            const salesByDate = {};
            currentUser.sales.forEach(sale => {
                const date = sale.date;
                if (!salesByDate[date]) salesByDate[date] = 0;
                salesByDate[date]++;
            });
            
            const sortedDates = Object.keys(salesByDate).sort();
            let currentStreak = 0;
            let maxStreak = 0;
            
            for (let i = 0; i < sortedDates.length; i++) {
                if (i === 0) {
                    currentStreak = 1;
                } else {
                    const prevDate = new Date(sortedDates[i - 1]);
                    const currDate = new Date(sortedDates[i]);
                    const diffDays = (currDate - prevDate) / (1000 * 60 * 60 * 24);
                    
                    if (diffDays === 1) {
                        currentStreak++;
                    } else {
                        maxStreak = Math.max(maxStreak, currentStreak);
                        currentStreak = 1;
                    }
                }
            }
            maxStreak = Math.max(maxStreak, currentStreak);
            
            // Conquistas de sequência (SEM PONTOS EXTRAS - apenas registro histórico)
            const streakAchievements = [
                { days: 3, name: 'Sequência de 3 Dias', icon: '🔥' },
                { days: 7, name: 'Semana Perfeita', icon: '⚡' },
                { days: 15, name: 'Quinzena Imparável', icon: '🚀' },
                { days: 30, name: 'Mês Consistente', icon: '💪' }
            ];
            
            streakAchievements.forEach(achievement => {
                if (maxStreak >= achievement.days && !currentUser.achievements.find(a => a.name === achievement.name)) {
                    currentUser.achievements.push({
                        type: 'streak_achievement',
                        name: achievement.name,
                        icon: achievement.icon,
                        description: `${achievement.days} dias consecutivos com vendas`,
                        date: new Date().toISOString()
                    });
                    
                    // Apenas notificação, SEM pontos extras
                    showNotification(`🏆 CONQUISTA: ${achievement.name}!`, 'success');
                }
            });
        }

        // Função para atualizar dados da aba home em tempo real
        function updateHomeTabData() {
            if (!currentUser) return;
            
            // Calcular pontos totais reais e sincronizar
            const realTotalPoints = calculateRealTotalPoints();
            if (currentUser.points !== realTotalPoints) {
                currentUser.points = realTotalPoints;
                saveUserData();
            }
            
            // Atualizar cards principais da home
            document.getElementById('totalSales').textContent = currentUser.sales ? currentUser.sales.length : 0;
            document.getElementById('rankPosition').textContent = getRankPosition() > 0 ? `${getRankPosition()}º` : '-';
            
            // Atualizar vendas recentes
            updateRecentSales();
            
            // Atualizar desafios ativos
            updateActiveChallenges();
        }

        // Funções de desempenho
        function updateSalesTable() {
            const tbody = document.getElementById('salesTableBody');
            
            if (!currentUser.sales || currentUser.sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-blue-200 text-center py-8">Nenhuma venda registrada ainda</td></tr>';
                return;
            }

            tbody.innerHTML = currentUser.sales.slice().reverse().map(sale => `
                <tr class="border-b border-white/10 hover:bg-white/5">
                    <td class="py-3 px-2 text-blue-200">${formatDate(sale.date)}</td>
                    <td class="py-3 px-2 text-white">${sale.client}</td>
                    <td class="py-3 px-2 text-blue-300">${sale.orderId}</td>
                    <td class="py-3 px-2">
                        <div>
                            <p class="text-white font-semibold">${sale.lensType}</p>
                            ${sale.antiReflective !== 'none' ? `<p class="text-blue-300 text-xs">• ${sale.antiReflective}</p>` : ''}
                            ${sale.sensity !== 'none' ? `<p class="text-green-300 text-xs">• ${sale.sensity}</p>` : ''}
                            ${sale.material ? `<p class="text-yellow-300 text-xs">• ${sale.material}</p>` : ''}
                        </div>
                    </td>
                    <td class="py-3 px-2 text-green-400 font-bold orbitron">${sale.points}</td>
                </tr>
            `).join('');
        }

        function updatePerformanceMetrics() {
            if (!currentUser) return;

            const totalSales = currentUser.sales.length;
            const monthSales = getMonthSales();
            const weekSales = getWeekSales().length;
            
            // Calcular ticket médio apenas com pontos de vendas (não inclui bônus de desafios/certificados)
            const totalSalesPoints = currentUser.sales.reduce((total, sale) => total + (sale.points || 0), 0);
            const avgTicket = totalSales > 0 ? Math.round(totalSalesPoints / totalSales) : 0;

            document.getElementById('totalGeneralSales').textContent = totalSales;
            document.getElementById('totalMonthlySales').textContent = monthSales;
            document.getElementById('totalWeeklySales').textContent = weekSales;
            document.getElementById('averageTicket').textContent = avgTicket;
        }

        // Funções de ranking
        function updateRanking() {
            const tbody = document.getElementById('rankingTableBody');
            
            // Ordenar usuários por pontos mensais (incluindo todas as categorias)
            const sortedUsers = users
                .filter(u => !u.isSystemUser)
                .sort((a, b) => {
                    const aMonthlyTotal = getMonthlyTotalPoints(a);
                    const bMonthlyTotal = getMonthlyTotalPoints(b);
                    return bMonthlyTotal - aMonthlyTotal;
                });

            if (sortedUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-blue-200 text-center py-8">Nenhum usuário no ranking ainda</td></tr>';
                return;
            }

            tbody.innerHTML = sortedUsers.map((user, index) => {
                const position = index + 1;
                const isCurrentUser = currentUser && user.id === currentUser.id;
                const rowClass = isCurrentUser ? 'bg-blue-600/20 border-blue-400' : 'border-white/10';
                
                const monthlyPoints = getMonthlyTotalPoints(user);
                const categorizedPoints = getCategorizedMonthlyPoints(user);
                
                return `
                    <tr class="border-b ${rowClass} hover:bg-white/5">
                        <td class="py-3 px-2 text-center">
                            <div class="flex items-center justify-center">
                                ${position <= 3 ? getPositionIcon(position) : ''}
                                <span class="orbitron text-white font-bold ${position <= 3 ? 'ml-2' : ''}">${position}º</span>
                            </div>
                        </td>
                        <td class="py-3 px-2">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white flex-shrink-0 overflow-hidden cursor-pointer hover:ring-2 hover:ring-blue-400 transition-all duration-300 border-2 border-blue-400/30" onclick="openUserDetailsModal(${user.id})" title="Ver detalhes de ${user.name}">
                                    ${user.profilePhoto ? 
                                        `<img src="${user.profilePhoto}" alt="Foto de ${user.name}" class="w-full h-full rounded-lg object-cover">` : 
                                        '<span class="text-sm">👤</span>'
                                    }
                                </div>
                                <div class="min-w-0 flex-1">
                                    <p class="text-white font-semibold truncate">${user.name}</p>
                                    <div class="flex space-x-2 text-xs mt-1">
                                        <span class="text-blue-300" title="Pontos de Vendas">📊 ${categorizedPoints.sales}</span>
                                        <span class="text-purple-300" title="Pontos de Desafios">🏆 ${categorizedPoints.challenges}</span>
                                        <span class="text-yellow-300" title="Pontos de Patentes">🎖️ ${categorizedPoints.ranks}</span>
                                        <span class="text-green-300" title="Pontos de Aulas">🎓 ${categorizedPoints.courses}</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 px-2 text-left">
                            <div>
                                <p class="text-blue-200 font-medium">${user.optica}</p>
                                <p class="text-blue-300 text-xs">${user.city}</p>
                            </div>
                        </td>
                        <td class="py-3 px-2 text-center">
                            <span class="text-blue-300 font-semibold">${user.sales ? user.sales.length : 0}</span>
                        </td>
                        <td class="py-3 px-2 text-right">
                            <div>
                                <p class="text-green-400 font-bold orbitron">${monthlyPoints.toLocaleString('pt-BR')}</p>
                                <p class="text-blue-300 text-xs">pts este mês</p>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Função para calcular pontos mensais totais (todas as categorias)
        function getMonthlyTotalPoints(user) {
            if (!user) return 0;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            let totalPoints = 0;
            
            // 1. Pontos de vendas do mês
            if (user.sales) {
                const monthSales = user.sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                });
                totalPoints += monthSales.reduce((sum, sale) => sum + (sale.points || 0), 0);
            }
            
            // 2. Pontos de desafios do mês
            if (user.challengePoints) {
                const monthChallenges = user.challengePoints.filter(challenge => {
                    const challengeDate = new Date(challenge.date);
                    return challengeDate.getMonth() === currentMonth && challengeDate.getFullYear() === currentYear;
                });
                totalPoints += monthChallenges.reduce((sum, challenge) => sum + (challenge.points || 0), 0);
            }
            
            // 3. Pontos de patentes do mês
            if (user.rankPoints) {
                const monthRanks = user.rankPoints.filter(rank => {
                    const rankDate = new Date(rank.date);
                    return rankDate.getMonth() === currentMonth && rankDate.getFullYear() === currentYear;
                });
                totalPoints += monthRanks.reduce((sum, rank) => sum + (rank.points || 0), 0);
            }
            
            // 4. Pontos de aulas/certificados do mês
            if (user.coursePoints) {
                const monthCourses = user.coursePoints.filter(course => {
                    const courseDate = new Date(course.date);
                    return courseDate.getMonth() === currentMonth && courseDate.getFullYear() === currentYear;
                });
                totalPoints += monthCourses.reduce((sum, course) => sum + (course.points || 0), 0);
            }
            
            return totalPoints;
        }
        
        // Função para obter pontos categorizados do mês
        function getCategorizedMonthlyPoints(user) {
            if (!user) return { sales: 0, challenges: 0, ranks: 0, courses: 0 };
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            let salesPoints = 0;
            let challengePoints = 0;
            let rankPoints = 0;
            let coursePoints = 0;
            
            // Pontos de vendas
            if (user.sales) {
                const monthSales = user.sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                });
                salesPoints = monthSales.reduce((sum, sale) => sum + (sale.points || 0), 0);
            }
            
            // Pontos de desafios
            if (user.challengePoints) {
                const monthChallenges = user.challengePoints.filter(challenge => {
                    const challengeDate = new Date(challenge.date);
                    return challengeDate.getMonth() === currentMonth && challengeDate.getFullYear() === currentYear;
                });
                challengePoints = monthChallenges.reduce((sum, challenge) => sum + (challenge.points || 0), 0);
            }
            
            // Pontos de patentes
            if (user.rankPoints) {
                const monthRanks = user.rankPoints.filter(rank => {
                    const rankDate = new Date(rank.date);
                    return rankDate.getMonth() === currentMonth && rankDate.getFullYear() === currentYear;
                });
                rankPoints = monthRanks.reduce((sum, rank) => sum + (rank.points || 0), 0);
            }
            
            // Pontos de cursos
            if (user.coursePoints) {
                const monthCourses = user.coursePoints.filter(course => {
                    const courseDate = new Date(course.date);
                    return courseDate.getMonth() === currentMonth && courseDate.getFullYear() === currentYear;
                });
                coursePoints = monthCourses.reduce((sum, course) => sum + (course.points || 0), 0);
            }
            
            return {
                sales: salesPoints,
                challenges: challengePoints,
                ranks: rankPoints,
                courses: coursePoints
            };
        }

        function getPositionIcon(position) {
            const icons = {
                1: '<span class="text-yellow-400 text-xl">🥇</span>',
                2: '<span class="text-gray-400 text-xl">🥈</span>',
                3: '<span class="text-orange-400 text-xl">🥉</span>'
            };
            return icons[position] || '';
        }

        // Funções de patentes
        function loadRanks() {
            const ranksList = document.getElementById('ranksList');
            const userPoints = currentUser ? (currentUser.salesPoints || 0) : 0;
            
            ranksList.innerHTML = ranks.map((rank, index) => {
                const isUnlocked = userPoints >= rank.points;
                const isCurrent = getCurrentRankIndex(userPoints) === index;
                const progress = index > 0 ? Math.min(100, (userPoints / rank.points) * 100) : 100;
                const pointsNeeded = Math.max(0, rank.points - userPoints);
                
                let cardClass = 'rank-card';
                if (isUnlocked) cardClass += ' rank-unlocked';
                if (isCurrent) cardClass += ' rank-current';
                
                return `
                    <div class="${cardClass} rounded-xl p-4 hover-glow">
                        <div class="text-center">
                            <div class="text-3xl mb-2">${rank.icon}</div>
                            <h3 class="text-white font-bold text-sm mb-1">${rank.name}</h3>
                            <p class="text-blue-200 text-xs mb-3">${rank.points.toLocaleString('pt-BR')} pontos necessários</p>
                            
                            ${!isUnlocked ? `
                                <div class="mb-2">
                                    <p class="text-xs text-blue-300 mb-1">Progresso</p>
                                    <div class="bg-black/30 rounded-full h-2 mb-1">
                                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full progress-bar" style="width: ${progress}%"></div>
                                    </div>
                                    <p class="text-xs text-blue-300">${progress.toFixed(1)}%</p>
                                </div>
                                <p class="text-xs text-gray-400 mb-2">Faltam ${pointsNeeded.toLocaleString('pt-BR')} pontos</p>
                                <p class="text-red-400 font-semibold text-xs">BLOQUEADA</p>
                            ` : ''}
                            
                            ${isUnlocked && !isCurrent ? '<p class="text-green-400 font-semibold text-xs">✓ DESBLOQUEADA</p>' : ''}
                            ${isCurrent ? '<p class="text-yellow-400 font-semibold text-xs">★ ATUAL</p>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getCurrentRank(points) {
            for (let i = ranks.length - 1; i >= 0; i--) {
                if (points >= ranks[i].points) {
                    return ranks[i].name;
                }
            }
            return ranks[0].name;
        }

        function getCurrentRankIndex(points) {
            for (let i = ranks.length - 1; i >= 0; i--) {
                if (points >= ranks[i].points) {
                    return i;
                }
            }
            return 0;
        }

        function checkRankUnlock() {
            if (!currentUser) return;
            
            // Inicializar arrays de pontos categorizados se não existirem
            if (!currentUser.rankPoints) currentUser.rankPoints = [];
            
            // Usar apenas salesPoints para patentes (não inclui pontos de desafios/certificados)
            const salesPoints = currentUser.salesPoints || 0;
            const currentRankIndex = getCurrentRankIndex(salesPoints);
            
            // Verificar todas as patentes que deveriam estar desbloqueadas
            for (let i = 0; i <= currentRankIndex; i++) {
                const rankName = ranks[i].name;
                if (!currentUser.unlockedRanks.includes(rankName)) {
                    currentUser.unlockedRanks.push(rankName);
                    
                    // Notificação especial para nova patente
                    if (i === currentRankIndex && i > 0) {
                        // Bônus de 1000 pontos por nova patente (exceto a primeira)
                        const rankBonus = 1000;
                        currentUser.points += rankBonus;
                        
                        // Registrar pontos de patente
                        currentUser.rankPoints.push({
                            type: 'rank_unlock',
                            rankName: rankName,
                            rankIndex: i,
                            points: rankBonus,
                            date: new Date().toISOString(),
                            description: `Patente ${rankName} desbloqueada`
                        });
                        
                        showNotification(`🎖️ PROMOÇÃO! Nova patente desbloqueada: ${rankName}! +${rankBonus} pontos bônus!`, 'success');
                        sendRankUnlockedMessage(rankName, i);
                        
                        // Adicionar conquista
                        if (!currentUser.achievements) currentUser.achievements = [];
                        currentUser.achievements.push({
                            type: 'rank',
                            rankName: rankName,
                            rankIndex: i,
                            pointsRequired: ranks[i].points,
                            bonusPoints: rankBonus,
                            date: new Date().toISOString()
                        });
                    }
                }
            }
            
            // Verificar se há patente próxima (motivação)
            if (currentRankIndex < ranks.length - 1) {
                const nextRank = ranks[currentRankIndex + 1];
                const pointsNeeded = nextRank.points - salesPoints;
                
                if (pointsNeeded <= 500 && pointsNeeded > 0) {
                    // Só mostrar se não mostrou recentemente
                    const lastMotivation = localStorage.getItem('lastMotivationNotification');
                    const now = Date.now();
                    
                    if (!lastMotivation || (now - parseInt(lastMotivation)) > 24 * 60 * 60 * 1000) {
                        showNotification(`🎯 Faltam apenas ${pointsNeeded} pontos para ${nextRank.name}!`, 'info');
                        localStorage.setItem('lastMotivationNotification', now.toString());
                    }
                }
            }
        }

        // Funções de treinamentos
        function loadTrainings() {
            const trainingsList = document.getElementById('trainingsList');
            
            trainingsList.innerHTML = trainings.map(training => {
                const userTraining = currentUser.certificates.find(c => c.courseId === training.id);
                const completedLessons = userTraining ? userTraining.completedLessons.length : 0;
                const totalLessons = training.lessons.length;
                const progress = (completedLessons / totalLessons) * 100;
                const isCompleted = completedLessons === totalLessons;
                
                return `
                    <div class="training-card rounded-xl p-6 hover-glow cursor-pointer" onclick="openCourse('${training.id}')">
                        <div class="text-center">
                            <div class="text-4xl mb-3">${training.icon}</div>
                            <h3 class="text-white font-bold text-lg mb-2">${training.name}</h3>
                            <p class="text-blue-200 text-sm mb-4">${training.description}</p>
                            
                            <div class="bg-black/30 rounded-full h-2 mb-2">
                                <div class="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full progress-bar" style="width: ${progress}%"></div>
                            </div>
                            
                            <p class="text-xs text-blue-300 mb-3">${completedLessons}/${totalLessons} aulas concluídas</p>
                            
                            ${isCompleted ? 
                                '<p class="text-green-400 font-semibold">✓ CERTIFICADO OBTIDO</p>' : 
                                '<p class="text-blue-400 font-semibold">📚 EM PROGRESSO</p>'
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openCourse(courseId) {
            const course = trainings.find(t => t.id === courseId);
            if (!course) return;
            
            const userTraining = currentUser.certificates.find(c => c.courseId === courseId) || {
                courseId: courseId,
                completedLessons: [],
                currentStage: 0,
                stagesCompleted: []
            };
            
            const stages = ['Bronze', 'Prata', 'Ouro', 'Diamante'];
            const stageIcons = ['🥉', '🥈', '🥇', '💎'];
            const stageColors = ['text-orange-400', 'text-gray-300', 'text-yellow-400', 'text-blue-300'];
            
            document.getElementById('courseModalTitle').textContent = course.name;
            document.getElementById('courseModalContent').innerHTML = `
                <div class="space-y-6">
                    <p class="text-blue-200 mb-6">${course.description}</p>
                    
                    <!-- Progresso das Etapas -->
                    <div class="bg-black/30 p-4 rounded-lg">
                        <h4 class="text-white font-semibold mb-3">Progresso do Certificado</h4>
                        <div class="grid grid-cols-4 gap-2">
                            ${stages.map((stage, index) => {
                                const isCompleted = userTraining.stagesCompleted.includes(stage);
                                const isCurrent = userTraining.currentStage === index && !isCompleted;
                                const isLocked = index > userTraining.currentStage;
                                
                                return `
                                    <div class="text-center p-2 rounded ${isCompleted ? 'bg-green-600/20 border border-green-500/30' : isCurrent ? 'bg-yellow-600/20 border border-yellow-500/30' : 'bg-gray-600/20 border border-gray-500/30'}">
                                        <div class="text-2xl mb-1">${stageIcons[index]}</div>
                                        <div class="text-xs ${isCompleted ? 'text-green-400' : isCurrent ? 'text-yellow-400' : 'text-gray-400'}">${stage}</div>
                                        ${isCompleted ? '<div class="text-green-400 text-xs">✓</div>' : isCurrent ? '<div class="text-yellow-400 text-xs">●</div>' : '<div class="text-gray-400 text-xs">○</div>'}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Aulas/Etapas -->
                    <div class="space-y-3">
                        ${course.lessons.map((lesson, index) => {
                            const stage = stages[index];
                            const isCompleted = userTraining.completedLessons.includes(lesson.id);
                            const canComplete = userTraining.currentStage === index;
                            const isLocked = index > userTraining.currentStage;
                            
                            return `
                                <div class="lesson-${isCompleted ? 'complete' : 'incomplete'} p-4 rounded-lg flex justify-between items-center ${isLocked ? 'opacity-50' : ''}">
                                    <div class="flex items-center">
                                        <div class="text-2xl mr-3">${stageIcons[index]}</div>
                                        <div>
                                            <h4 class="text-white font-semibold">${stage} - ${lesson.name}</h4>
                                            <p class="text-blue-200 text-sm">Etapa ${lesson.id} • +50 pontos</p>
                                        </div>
                                    </div>
                                    <div>
                                        ${isCompleted ? 
                                            '<span class="text-green-400 text-xl">✓</span>' : 
                                            canComplete ? 
                                                `<button onclick="completeLesson('${courseId}', ${lesson.id})" class="gamer-button px-3 py-1 rounded text-white text-sm hover-glow">Completar ${stage}</button>` :
                                                '<span class="text-gray-400 text-sm">🔒 Bloqueado</span>'
                                        }
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Botão Resgatar Certificado -->
                    ${userTraining.readyForCertificate && !userTraining.certificateUnlocked ? 
                        `<div class="mt-6 p-4 bg-gradient-to-r from-green-600/20 to-blue-600/20 border border-green-500/30 rounded-lg text-center">
                            <p class="text-green-400 font-semibold mb-3">🏆 Parabéns! Todas as etapas concluídas!</p>
                            <button onclick="unlockCertificate('${courseId}')" class="gamer-button px-6 py-2 rounded-lg text-white font-semibold hover-glow">
                                RESGATAR CERTIFICADO (+400 pontos)
                            </button>
                        </div>` : 
                        userTraining.certificateUnlocked ?
                        `<div class="mt-6 p-4 bg-green-600/20 border border-green-500/30 rounded-lg text-center">
                            <p class="text-green-400 font-semibold">🎓 CERTIFICADO OBTIDO!</p>
                            <p class="text-green-300 text-sm mt-1">Resgatado em ${new Date(userTraining.certificateDate).toLocaleDateString('pt-BR')}</p>
                        </div>` : 
                        `<div class="mt-6 p-4 bg-blue-600/20 border border-blue-500/30 rounded-lg text-center">
                            <p class="text-blue-400 font-semibold">Complete todas as 4 etapas em sequência para resgatar o certificado!</p>
                            <p class="text-blue-300 text-sm mt-1">Cada etapa: +50 pontos • Certificado completo: +400 pontos extras</p>
                        </div>`
                    }
                </div>
            `;
            
            document.getElementById('courseModal').classList.remove('hidden');
        }

        function completeLesson(courseId, lessonId) {
            if (!currentUser) return;
            
            // Inicializar arrays de pontos categorizados se não existirem
            if (!currentUser.coursePoints) currentUser.coursePoints = [];
            
            let userTraining = currentUser.certificates.find(c => c.courseId === courseId);
            if (!userTraining) {
                userTraining = {
                    courseId: courseId,
                    completedLessons: [],
                    currentStage: 0, // 0=bronze, 1=prata, 2=ouro, 3=diamante
                    stagesCompleted: []
                };
                currentUser.certificates.push(userTraining);
            }
            
            // Sistema de etapas sequenciais: Bronze → Prata → Ouro → Diamante
            const stages = ['Bronze', 'Prata', 'Ouro', 'Diamante'];
            const requiredStage = lessonId - 1; // Lesson 1 = Bronze (index 0)
            
            // Só pode completar se for a próxima etapa em sequência
            if (requiredStage === userTraining.currentStage) {
                if (!userTraining.completedLessons.includes(lessonId)) {
                    userTraining.completedLessons.push(lessonId);
                    userTraining.stagesCompleted.push(stages[requiredStage]);
                    
                    // Pontos por completar etapa
                    const stagePoints = 50;
                    currentUser.points += stagePoints;
                    
                    // Registrar pontos de curso
                    const course = trainings.find(t => t.id === courseId);
                    currentUser.coursePoints.push({
                        type: 'lesson_complete',
                        courseId: courseId,
                        courseName: course.name,
                        stage: stages[requiredStage],
                        lessonId: lessonId,
                        points: stagePoints,
                        date: new Date().toISOString(),
                        description: `${course.name} - Etapa ${stages[requiredStage]}`
                    });
                    
                    showNotification(`🎓 Etapa ${stages[requiredStage]} concluída! +${stagePoints} pontos`, 'success');
                    sendLessonCompletionMessage(courseId, stages[requiredStage]);
                    
                    // Avançar para próxima etapa
                    userTraining.currentStage++;
                    
                    // Se completou todas as 4 etapas, liberar certificado
                    if (userTraining.currentStage >= 4) {
                        userTraining.readyForCertificate = true;
                        showNotification(`🏆 Todas as etapas concluídas! Agora você pode RESGATAR CERTIFICADO (+400 pontos)`, 'success');
                    }
                    
                    saveUserData();
                    updateUserInterface();
                    
                    // Atualizar dados em tempo real na aba home
                    updateHomeTabData();
                    
                    // Atualizar a lista de treinamentos na aba principal
                    loadTrainings();
                    
                    // Recarregar modal do curso
                    openCourse(courseId);
                }
            } else if (requiredStage < userTraining.currentStage) {
                showNotification('Esta etapa já foi concluída!', 'info');
            } else {
                showNotification(`Complete a etapa ${stages[userTraining.currentStage]} primeiro!`, 'error');
            }
        }
        
        function unlockCertificate(courseId) {
            if (!currentUser) return;
            
            // Inicializar arrays de pontos categorizados se não existirem
            if (!currentUser.coursePoints) currentUser.coursePoints = [];
            
            const userTraining = currentUser.certificates.find(c => c.courseId === courseId);
            if (userTraining && userTraining.readyForCertificate && !userTraining.certificateUnlocked) {
                userTraining.certificateUnlocked = true;
                userTraining.certificateDate = new Date().toISOString();
                
                // +400 pontos por resgatar certificado
                const certificatePoints = 400;
                currentUser.points += certificatePoints;
                
                const course = trainings.find(t => t.id === courseId);
                
                // Registrar pontos de certificado
                currentUser.coursePoints.push({
                    type: 'certificate_unlock',
                    courseId: courseId,
                    courseName: course.name,
                    points: certificatePoints,
                    date: new Date().toISOString(),
                    description: `Certificado ${course.name} resgatado`
                });
                
                showNotification(`🏆 CERTIFICADO RESGATADO: ${course.name}! +${certificatePoints} pontos extras!`, 'success');
                sendCertificateUnlockedMessage(courseId);
                
                // Adicionar conquista especial
                if (!currentUser.achievements) currentUser.achievements = [];
                currentUser.achievements.push({
                    type: 'certificate',
                    courseId: courseId,
                    courseName: course.name,
                    date: new Date().toISOString(),
                    points: certificatePoints
                });
                
                saveUserData();
                updateUserInterface();
                
                // Atualizar dados em tempo real na aba home
                updateHomeTabData();
                
                // Atualizar a lista de treinamentos na aba principal
                loadTrainings();
                
                // Recarregar modal do curso
                openCourse(courseId);
            } else if (userTraining && userTraining.certificateUnlocked) {
                showNotification('Certificado já foi resgatado!', 'info');
            } else {
                showNotification('Complete todas as 4 etapas primeiro!', 'error');
            }
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.add('hidden');
        }

        // Funções do modal de detalhes do usuário
        function openUserDetailsModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const totalSales = user.sales ? user.sales.length : 0;
            const monthlyPoints = getMonthlyTotalPoints(user);
            const categorizedPoints = getCategorizedMonthlyPoints(user);
            const totalPoints = user.points || 0;
            const currentRank = getCurrentRank(user.salesPoints || 0);
            
            // Calcular média de pontos por venda
            const totalSalesPoints = user.sales ? user.sales.reduce((sum, sale) => sum + (sale.points || 0), 0) : 0;
            const avgPointsPerSale = totalSales > 0 ? Math.round(totalSalesPoints / totalSales) : 0;
            
            // Verificar especialidades (produtos mais vendidos) - só mostra após 30 vendas de lentes
            let specialty = 'Nenhuma especialidade';
            if (user.sales && user.sales.length >= 30) {
                const productCount = {};
                user.sales.forEach(sale => {
                    productCount[sale.lensType] = (productCount[sale.lensType] || 0) + 1;
                });
                const mostSold = Object.entries(productCount).sort((a, b) => b[1] - a[1])[0];
                if (mostSold && mostSold[1] > 0) {
                    specialty = `${mostSold[0]} (${mostSold[1]} vendas)`;
                }
            } else if (user.sales && user.sales.length > 0) {
                specialty = `${user.sales.length}/30 vendas para especialidade`;
            }
            
            // Certificados conquistados
            const certificates = user.certificates ? user.certificates.filter(c => c.certificateUnlocked) : [];
            
            // Patentes conquistadas
            const unlockedRanks = user.unlockedRanks || ['Consultor Iniciante'];
            
            document.getElementById('userDetailsContent').innerHTML = `
                <div class="space-y-6">
                    <!-- Perfil do Usuário -->
                    <div class="text-center">
                        <div class="w-20 h-20 rounded-lg flex items-center justify-center text-white font-bold text-2xl mx-auto mb-3 overflow-hidden border-2 border-blue-400/30">
                            ${user.profilePhoto ? 
                                `<img src="${user.profilePhoto}" alt="Foto de ${user.name}" class="w-full h-full rounded-lg object-cover">` : 
                                '<span class="text-2xl">👤</span>'
                            }
                        </div>
                        <h3 class="text-white text-xl font-bold">${user.name}</h3>
                        <p class="text-blue-200">${user.function} - ${user.optica}</p>
                        <p class="text-blue-300 text-sm">${user.city}</p>
                    </div>
                    
                    <!-- Métricas Principais -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass-effect p-4 rounded-lg text-center">
                            <p class="text-blue-200 text-sm mb-1">Total de Vendas</p>
                            <p class="text-white text-2xl font-bold orbitron">${totalSales}</p>
                        </div>
                        <div class="glass-effect p-4 rounded-lg text-center">
                            <p class="text-blue-200 text-sm mb-1">Pontos Mensais</p>
                            <p class="text-green-400 text-2xl font-bold orbitron">${monthlyPoints.toLocaleString('pt-BR')}</p>
                        </div>
                        <div class="glass-effect p-4 rounded-lg text-center">
                            <p class="text-blue-200 text-sm mb-1">Pontos Totais</p>
                            <p class="text-blue-400 text-2xl font-bold orbitron">${totalPoints.toLocaleString('pt-BR')}</p>
                        </div>
                        <div class="glass-effect p-4 rounded-lg text-center">
                            <p class="text-blue-200 text-sm mb-1">Patente Atual</p>
                            <p class="text-yellow-400 text-lg font-bold">${currentRank}</p>
                        </div>
                    </div>
                    
                    <!-- Informações Adicionais -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-effect p-4 rounded-lg">
                            <h4 class="text-white font-semibold mb-2">Especialista</h4>
                            <p class="text-blue-200 text-sm">${specialty}</p>
                        </div>
                        <div class="glass-effect p-4 rounded-lg">
                            <h4 class="text-white font-semibold mb-2">Média de Pontos</h4>
                            <p class="text-blue-200 text-sm">${avgPointsPerSale} pts/venda</p>
                        </div>
                    </div>
                    
                    <!-- Detalhamento Mensal -->
                    <div class="glass-effect p-4 rounded-lg">
                        <h4 class="text-white font-semibold mb-3">Detalhamento Mensal</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-blue-200">Pontos por Vendas:</span>
                                <span class="text-white font-semibold">${categorizedPoints.sales.toLocaleString('pt-BR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-200">Pontos por Desafios:</span>
                                <span class="text-purple-400 font-semibold">${categorizedPoints.challenges.toLocaleString('pt-BR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-200">Pontos por Cursos:</span>
                                <span class="text-green-400 font-semibold">${categorizedPoints.courses.toLocaleString('pt-BR')}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-200">Pontos por Patentes:</span>
                                <span class="text-yellow-400 font-semibold">${categorizedPoints.ranks.toLocaleString('pt-BR')}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Certificados Conquistados -->
                    <div class="glass-effect p-4 rounded-lg">
                        <h4 class="text-white font-semibold mb-3 flex items-center">
                            <span class="mr-2">🏆</span>
                            Certificados Conquistados
                        </h4>
                        ${certificates.length > 0 ? 
                            certificates.map(cert => {
                                const course = trainings.find(t => t.id === cert.courseId);
                                return `
                                    <div class="flex items-center justify-between p-2 bg-green-600/20 border border-green-500/30 rounded-lg mb-2">
                                        <div class="flex items-center">
                                            <span class="text-xl mr-2">🎓</span>
                                            <div>
                                                <p class="text-green-400 font-semibold text-sm">${course ? course.name : 'Curso'}</p>
                                                <p class="text-green-300 text-xs">Conquistado em ${new Date(cert.certificateDate).toLocaleDateString('pt-BR')}</p>
                                            </div>
                                        </div>
                                        <span class="text-green-400 font-bold text-sm">+400 pts</span>
                                    </div>
                                `;
                            }).join('') : 
                            '<p class="text-blue-200 text-sm text-center py-4">Nenhum certificado conquistado ainda</p>'
                        }
                    </div>
                    
                    <!-- Patentes Conquistadas -->
                    <div class="glass-effect p-4 rounded-lg">
                        <h4 class="text-white font-semibold mb-3 flex items-center">
                            <span class="mr-2">🎖️</span>
                            Patentes Conquistadas
                        </h4>
                        <div class="space-y-2">
                            ${(() => {
                                const currentRankIndex = getCurrentRankIndex(user.salesPoints || 0);
                                const currentRank = ranks[currentRankIndex];
                                const nextRank = currentRankIndex < ranks.length - 1 ? ranks[currentRankIndex + 1] : null;
                                const currentSalesPoints = user.salesPoints || 0;
                                
                                return `
                                    <div class="flex items-center justify-between p-3 bg-blue-600/20 border border-blue-500/30 rounded-lg">
                                        <div class="flex items-center">
                                            <span class="text-xl mr-2">🎖️</span>
                                            <div>
                                                <p class="text-blue-400 font-semibold text-sm">${currentRank.name}</p>
                                                <p class="text-blue-300 text-xs">${currentSalesPoints.toLocaleString('pt-BR')} pts atual</p>
                                                ${nextRank ? `<p class="text-yellow-300 text-xs">Próxima patente: ${nextRank.points.toLocaleString('pt-BR')} pts</p>` : '<p class="text-green-300 text-xs">Patente máxima conquistada!</p>'}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-green-400 font-bold text-sm">ATUAL</span>
                                            ${nextRank ? `<p class="text-yellow-300 text-xs">Faltam: ${(nextRank.points - currentSalesPoints).toLocaleString('pt-BR')}</p>` : ''}
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('userDetailsModal').classList.remove('hidden');
        }
        
        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').classList.add('hidden');
        }
        
        // Funções de perfil
        function openProfileModal() {
            if (!currentUser) return;
            
            document.getElementById('profileName').value = currentUser.name || '';
            document.getElementById('profilePhone').value = currentUser.phone || '';
            document.getElementById('profileCity').value = currentUser.city || '';
            document.getElementById('profileOptica').value = currentUser.optica || '';
            document.getElementById('profileHoyaCode').value = currentUser.hoyaCode || '';
            
            updateProfilePhoto();
            document.getElementById('profileModal').classList.remove('hidden');
        }
        
        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
        }
        
        function changeProfilePhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentUser.profilePhoto = e.target.result;
                        updateProfilePhoto();
                        saveUserData();
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        function saveProfile() {
            if (!currentUser) return;
            
            const name = document.getElementById('profileName').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            const city = document.getElementById('profileCity').value.trim();
            const optica = document.getElementById('profileOptica').value.trim();
            const hoyaCode = document.getElementById('profileHoyaCode').value.trim();
            
            if (!name || !phone || !city || !optica || !hoyaCode) {
                showNotification('Por favor, preencha todos os campos!', 'error');
                return;
            }
            
            currentUser.name = name;
            currentUser.phone = phone;
            currentUser.city = city;
            currentUser.optica = optica;
            currentUser.hoyaCode = hoyaCode;
            
            saveUserData();
            updateUserInterface();
            
            closeProfileModal();
            showNotification('Perfil atualizado com sucesso!', 'success');
        }
        
        // Funções de modais
        function openRulesModal() {
            document.getElementById('rulesModal').classList.remove('hidden');
        }
        
        function closeRulesModal() {
            document.getElementById('rulesModal').classList.add('hidden');
        }
        
        function openMessagesModal() {
            loadMessages();
            document.getElementById('messagesModal').classList.remove('hidden');
            // Marcar mensagens como lidas
            markMessagesAsRead();
        }
        
        function closeMessagesModal() {
            document.getElementById('messagesModal').classList.add('hidden');
        }
        
        // Sistema de mensagens
        function initializeMessages() {
            if (!currentUser.messages) {
                currentUser.messages = [
                    {
                        id: 1,
                        title: '🎉 Bem-vindo ao Torneio HOYA 2025!',
                        content: 'Participe do maior torneio de vendas HOYA e concorra a prêmios incríveis! Registre suas vendas e acompanhe seu progresso em tempo real.',
                        date: new Date().toISOString(),
                        read: false
                    },
                    {
                        id: 2,
                        title: '📚 Novos Cursos Disponíveis',
                        content: 'Complete os treinamentos e ganhe certificados valiosos. Cada certificado completo vale 400 pontos extras!',
                        date: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(), // Ontem
                        read: false
                    }
                ];
                saveUserData();
            }
        }
        
        function loadMessages() {
            if (!currentUser) return;
            
            initializeMessages();
            
            const messagesContent = document.getElementById('messagesContent');
            
            if (currentUser.messages.length === 0) {
                messagesContent.innerHTML = '<p class="text-blue-200 text-center py-8">Nenhuma mensagem</p>';
                return;
            }
            
            messagesContent.innerHTML = currentUser.messages.map(message => `
                <div class="glass-effect p-4 rounded-lg relative">
                    <button onclick="deleteMessage(${message.id})" class="absolute top-2 right-2 w-6 h-6 bg-red-600/80 hover:bg-red-600 rounded-full flex items-center justify-center text-white text-xs transition-all duration-300 hover:scale-110" title="Excluir mensagem">
                        ✕
                    </button>
                    <div class="flex justify-between items-start mb-2 pr-8">
                        <h4 class="text-white font-semibold">${message.title}</h4>
                        <span class="text-blue-300 text-xs">${formatMessageDate(message.date)}</span>
                    </div>
                    <p class="text-blue-200 text-sm">${message.content}</p>
                </div>
            `).join('');
        }
        
        function deleteMessage(messageId) {
            if (!currentUser || !currentUser.messages) return;
            
            currentUser.messages = currentUser.messages.filter(msg => msg.id !== messageId);
            
            // Atualizar contador de mensagens não lidas
            const unreadCount = currentUser.messages.filter(msg => !msg.read).length;
            currentUser.unreadMessages = unreadCount;
            
            saveUserData();
            loadMessages();
            updateMessagesBadge();
            
            showNotification('Mensagem excluída!', 'success');
        }
        
        // Sistema de mensagens automáticas
        function addSystemMessage(title, content, category = 'system') {
            if (!currentUser) return;
            
            if (!currentUser.messages) currentUser.messages = [];
            
            const newMessage = {
                id: Date.now() + Math.random(),
                title: title,
                content: content,
                category: category,
                date: new Date().toISOString(),
                read: false
            };
            
            currentUser.messages.unshift(newMessage); // Adicionar no início
            
            // Manter apenas as últimas 50 mensagens
            if (currentUser.messages.length > 50) {
                currentUser.messages = currentUser.messages.slice(0, 50);
            }
            
            currentUser.unreadMessages = (currentUser.unreadMessages || 0) + 1;
            updateMessagesBadge();
            saveUserData();
        }
        
        function sendSaleCongratulatoryMessage(sale) {
            const messages = [
                `🎯 Parabéns pela venda de ${sale.lensType}! Você ganhou ${sale.points} pontos.`,
                `🔥 Excelente! Mais uma venda registrada: ${sale.lensType} (+${sale.points} pts)`,
                `⭐ Ótimo trabalho! ${sale.lensType} vendida com sucesso. +${sale.points} pontos!`,
                `🚀 Continue assim! Venda de ${sale.lensType} registrada (+${sale.points} pts)`
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            
            let extraInfo = '';
            if (sale.antiReflective !== 'none') extraInfo += ` com ${sale.antiReflective}`;
            if (sale.sensity !== 'none') extraInfo += ` e ${sale.sensity}`;
            if (sale.material) extraInfo += ` em material ${sale.material}`;
            
            const fullMessage = randomMessage + (extraInfo ? ` Produtos adicionais:${extraInfo}.` : '');
            
            // Sempre adicionar mensagem de parabéns para cada venda
            addSystemMessage('🎉 Nova Venda Registrada!', fullMessage, 'sale');
        }
        
        function sendRankingPositionMessage() {
            const position = getRankPosition();
            if (position === 0) return;
            
            let message = '';
            let title = '';
            
            if (position === 1) {
                title = '👑 Você está em 1º lugar!';
                message = 'Parabéns! Você lidera o ranking geral. Continue assim para manter a liderança!';
            } else if (position === 2) {
                title = '🥈 2º lugar no ranking!';
                message = 'Excelente posição! Você está muito próximo da liderança. Continue vendendo!';
            } else if (position === 3) {
                title = '🥉 3º lugar no ranking!';
                message = 'Parabéns! Você está no pódio. Mantenha o ritmo para subir ainda mais!';
            } else if (position <= 5) {
                title = '⭐ Top 5 no ranking!';
                message = `Você está em ${position}º lugar! Muito bem, continue assim para chegar ao pódio!`;
            } else if (position <= 10) {
                title = '🔥 Top 10 no ranking!';
                message = `Posição ${position}º no ranking geral. Você está entre os melhores!`;
            } else if (position <= 20) {
                title = '📈 Top 20 no ranking!';
                message = `${position}º lugar no ranking. Continue vendendo para subir ainda mais!`;
            }
            
            if (message) {
                addSystemMessage(title, message, 'ranking');
            }
        }
        
        function sendChallengeProgressMessage() {
            if (!currentUser.challenges) return;
            
            const challenges = currentUser.challenges;
            
            // Verificar desafios semanais próximos da conclusão
            Object.entries(challenges.weekly).forEach(([key, challenge]) => {
                const progress = challenge.current / challenge.target;
                const remaining = challenge.target - challenge.current;
                
                if (progress >= 0.8 && remaining > 0 && remaining <= 2) {
                    let challengeName = '';
                    switch(key) {
                        case 'miyosmart': challengeName = 'MiYoSmart'; break;
                        case 'variety': challengeName = 'Variedade'; break;
                        case 'premium': challengeName = 'Premium 1.74'; break;
                        case 'sensity': challengeName = 'Sensity'; break;
                    }
                    
                    addSystemMessage(
                        `🎯 Desafio ${challengeName} quase completo!`,
                        `Faltam apenas ${remaining} ${remaining === 1 ? 'venda' : 'vendas'} para completar o desafio ${challengeName} e ganhar +${challenge.reward} pontos bônus!`,
                        'challenge'
                    );
                }
            });
            
            // Verificar desafios mensais
            Object.entries(challenges.monthly).forEach(([key, challenge]) => {
                const progress = challenge.current / challenge.target;
                const remaining = challenge.target - challenge.current;
                
                if (progress >= 0.8 && remaining > 0 && remaining <= 5) {
                    let challengeName = key === 'sales' ? 'Meta de Vendas' : 'Meta de Pontos';
                    let unit = key === 'sales' ? 'vendas' : 'pontos';
                    
                    addSystemMessage(
                        `📅 ${challengeName} Mensal quase completa!`,
                        `Faltam apenas ${remaining} ${unit} para completar a ${challengeName} Mensal e ganhar +${challenge.reward} pontos bônus!`,
                        'challenge'
                    );
                }
            });
        }
        
        function sendRankProgressMessage() {
            if (!currentUser) return;
            
            const salesPoints = currentUser.salesPoints || 0;
            const currentRankIndex = getCurrentRankIndex(salesPoints);
            
            if (currentRankIndex < ranks.length - 1) {
                const nextRank = ranks[currentRankIndex + 1];
                const pointsNeeded = nextRank.points - salesPoints;
                const progress = salesPoints / nextRank.points;
                
                // Mensagem quando está próximo (90% ou menos de 1000 pontos)
                if (progress >= 0.9 || pointsNeeded <= 1000) {
                    addSystemMessage(
                        '🎖️ Próxima patente se aproxima!',
                        `Você está muito próximo da patente ${nextRank.name}! Faltam apenas ${pointsNeeded.toLocaleString('pt-BR')} pontos para desbloquear e ganhar +1000 pontos bônus!`,
                        'rank'
                    );
                }
                // Mensagem de motivação quando está a meio caminho
                else if (progress >= 0.5 && progress < 0.7) {
                    addSystemMessage(
                        '💪 Continue assim!',
                        `Você já conquistou ${(progress * 100).toFixed(0)}% dos pontos necessários para a patente ${nextRank.name}. Faltam ${pointsNeeded.toLocaleString('pt-BR')} pontos!`,
                        'motivation'
                    );
                }
            }
        }
        
        function sendLessonCompletionMessage(courseId, stage) {
            const course = trainings.find(t => t.id === courseId);
            if (!course) return;
            
            addSystemMessage(
                `🎓 Etapa ${stage} concluída!`,
                `Parabéns! Você completou a etapa ${stage} do curso ${course.name} e ganhou +50 pontos. Continue para desbloquear o certificado completo!`,
                'course'
            );
        }
        
        function sendCertificateUnlockedMessage(courseId) {
            const course = trainings.find(t => t.id === courseId);
            if (!course) return;
            
            addSystemMessage(
                '🏆 Certificado conquistado!',
                `Excelente! Você conquistou o certificado completo de ${course.name} e ganhou +400 pontos extras. Parabéns pela dedicação!`,
                'certificate'
            );
        }
        
        function sendRankUnlockedMessage(rankName, rankIndex) {
            const motivationalMessages = [
                'Sua dedicação está sendo recompensada!',
                'Você está evoluindo constantemente!',
                'Excelente progresso na sua carreira!',
                'Continue assim, você é um exemplo!'
            ];
            
            const randomMotivation = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
            
            addSystemMessage(
                `🎖️ Nova patente desbloqueada: ${rankName}!`,
                `Parabéns! Você conquistou a patente ${rankName} e ganhou +1000 pontos bônus. ${randomMotivation}`,
                'rank'
            );
        }
        
        function sendChallengeCompletedMessage(challengeType, challengeName, reward) {
            const congratulations = [
                'Incrível!',
                'Fantástico!',
                'Excelente trabalho!',
                'Parabéns!',
                'Muito bem!'
            ];
            
            const randomCongrats = congratulations[Math.floor(Math.random() * congratulations.length)];
            
            addSystemMessage(
                `🏆 Desafio ${challengeName} concluído!`,
                `${randomCongrats} Você completou o desafio ${challengeName} e ganhou +${reward} pontos bônus. Continue assim!`,
                'challenge'
            );
        }
        
        function formatMessageDate(dateString) {
            const messageDate = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - messageDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Hoje';
            if (diffDays === 2) return 'Ontem';
            if (diffDays <= 7) return `${diffDays - 1} dias atrás`;
            
            return messageDate.toLocaleDateString('pt-BR');
        }
        
        function markMessagesAsRead() {
            if (!currentUser || !currentUser.messages) return;
            
            // Marcar todas as mensagens como lidas
            currentUser.messages.forEach(message => {
                message.read = true;
            });
            
            currentUser.unreadMessages = 0;
            saveUserData();
            updateMessagesBadge();
        }
        
        function updateMessagesBadge() {
            const badge = document.getElementById('messagesBadge');
            const badgeDesktop = document.getElementById('messagesBadgeDesktop');
            if (!currentUser) return;
            
            // Inicializar mensagens se não existirem
            initializeMessages();
            
            // Contar mensagens não lidas
            const unreadCount = currentUser.messages ? currentUser.messages.filter(msg => !msg.read).length : 0;
            currentUser.unreadMessages = unreadCount;
            
            if (unreadCount > 0) {
                if (badge) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'flex';
                }
                if (badgeDesktop) {
                    badgeDesktop.textContent = unreadCount;
                    badgeDesktop.style.display = 'flex';
                }
            } else {
                if (badge) badge.style.display = 'none';
                if (badgeDesktop) badgeDesktop.style.display = 'none';
            }
        }

        // Funções de prêmios
        function updatePrizesTab() {
            const rankPosition = getRankPosition();
            const monthPoints = getMonthPoints();
            
            document.getElementById('currentPosition').textContent = rankPosition > 0 ? `${rankPosition}º` : '-';
            document.getElementById('currentMonthPoints').textContent = monthPoints.toLocaleString('pt-BR');
            
            let nextPrize = 'Continue vendendo!';
            if (rankPosition === 1) nextPrize = 'Você está em 1º!';
            else if (rankPosition === 2) nextPrize = 'Falta pouco para o 1º!';
            else if (rankPosition === 3) nextPrize = 'Você está no pódio!';
            else if (rankPosition <= 10) nextPrize = 'Top 10!';
            
            document.getElementById('nextPrize').textContent = nextPrize;
        }

        // Funções utilitárias
        function getMonthSales() {
            if (!currentUser || !currentUser.sales) return 0;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            return currentUser.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            }).length;
        }

        function getMonthSalesArray() {
            if (!currentUser || !currentUser.sales) return [];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            return currentUser.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
        }

        function getQuarterSalesArray() {
            if (!currentUser || !currentUser.sales) return [];
            const currentDate = new Date();
            const currentQuarter = Math.floor(currentDate.getMonth() / 3);
            const currentYear = currentDate.getFullYear();
            
            return currentUser.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                const saleQuarter = Math.floor(saleDate.getMonth() / 3);
                return saleQuarter === currentQuarter && saleDate.getFullYear() === currentYear;
            });
        }

        function getQuarterId() {
            const now = new Date();
            const quarter = Math.floor(now.getMonth() / 3) + 1;
            return `${now.getFullYear()}-Q${quarter}`;
        }

        function getWeekSales() {
            if (!currentUser || !currentUser.sales) return [];
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            return currentUser.sales.filter(sale => new Date(sale.date) >= oneWeekAgo);
        }

        function getMonthPoints() {
            if (!currentUser || !currentUser.sales) return 0;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            return currentUser.sales
                .filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
                })
                .reduce((total, sale) => total + sale.points, 0);
        }

        function getRankPosition() {
            if (!currentUser) return 0;
            const sortedUsers = users
                .filter(u => !u.isSystemUser)
                .sort((a, b) => (b.points || 0) - (a.points || 0));
            return sortedUsers.findIndex(u => u.id === currentUser.id) + 1;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function saveUserData() {
            localStorage.setItem('hoyaUsers', JSON.stringify(users));
        }

        function loadUserData() {
            const savedUsers = localStorage.getItem('hoyaUsers');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
        }

        function showNotification(message, type = 'info') {
            // Remove any existing notifications to prevent overlap
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notif => {
                notif.remove();
            });
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Force multiple reflows to ensure proper rendering
            notification.offsetHeight;
            notification.getBoundingClientRect();
            
            // Use requestAnimationFrame for better timing
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    notification.classList.add('show');
                });
            });
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            
            // Definir data padrão como hoje
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('saleDate').value = today;
            
            // Verificar se há usuário logado
            const savedCurrentUser = localStorage.getItem('hoyaCurrentUser');
            if (savedCurrentUser) {
                const userData = JSON.parse(savedCurrentUser);
                currentUser = users.find(u => u.id === userData.id);
                if (currentUser) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainSystem').classList.remove('hidden');
                    setupUserInterface();
                    updateUserInterface();
                    showTab('home');
                    
                    // Garantir carregamento completo dos dados da home
                    const forceHomeUpdate = () => {
                        updateActiveChallenges();
                        updateRecentSales();
                        updateDashboard();
                        updateHomeTabData();
                    };
                    
                    // Múltiplas chamadas para garantir carregamento
                    forceHomeUpdate();
                    
                    requestAnimationFrame(() => {
                        forceHomeUpdate();
                    });
                    
                    setTimeout(() => {
                        forceHomeUpdate();
                    }, 100);
                    
                    setTimeout(() => {
                        forceHomeUpdate();
                    }, 300);
                }
            }
        });

        // Salvar usuário atual no localStorage
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                localStorage.setItem('hoyaCurrentUser', JSON.stringify({id: currentUser.id}));
            } else {
                localStorage.removeItem('hoyaCurrentUser');
            }
        });
    </script>
<script> <script type="module" src="app.js"></script>
 function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97451437b56ecacf',t:'MTc1NjA2MTg4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<!-- Ranking Section -->
<div class="section" id="ranking" style="display: none;">
  <div id="rankingContainer" class="space-y-4 p-6 bg-white rounded-xl shadow-md mt-6">
    <!-- O ranking será carregado automaticamente aqui pelo app.js -->
  </div>
</div>
</html>


